# 1. 电商Java后端技术栈分析

# Web项目梳理
> 在平常的项目中，有什么工具是不可缺少的，或者有什么辅助包是可以极大的提高我们的工作效率的呢？搭建一个web服务，我们会遇到些什么问题，又改如何去解决呢？

## 电商后端的梳理
> 由于本人是一枚传统的电商行业的后端码农，基于java的技术栈提供http服务，因此主要以电商技术体系进行梳理介绍说明

### 说明

一般而言，电商后端采用的技术栈如下（只做参考）

MVC开发模式

**Controller:**

- 一般是通过spring-mvc提供http服务
- 类似的也有spring-boot, jfinal


**View:**

- 现在提倡前后端分离，一般是后端只提供数据，前端访问，异步渲染or直出
- 前端可选择的方案，实在太多，不予列出


**Model:**

- 数据层，一般而言，采用mysql进行数据存储，这个涉及的点比较多，后面详细说明

## 庖丁解牛
> 从上到下，看一下搭建一个web服务，会用到哪些技术

### I. web层

首先，我们借助spring家族，配合tomcat搭建一个web服务器

#### 1. springMvc提供http服务

> 首先我们利用spring-mvc 提供http服务

web服务，最常见的一个是安全问题，一些常见的case及解决手段

| case | fix |
| --- | --- |
| 提交表单，xss,sql注入 | 校验用户提交内容，`apache.commons.lang3.StringEscapeUtils` |
| csrf | token或者referer校验 |
| 提供下载服务时，额外注意ssrf  | 对于下载的url，进行安全校验，判断是否可信 |

一般来说，安全校验不可缺少，但是如果每个地方都进行校验，就很麻烦了，最常见的处理手段是

实现一个filter 或 intercepter，在过滤器or拦截器中做相关的安全校验逻辑


#### 2. 跨域问题

> 非常常见的一个问题了，使用姿势也挺多

后端支持跨域解决方法:

- 在Controller的方法上添加注解 `CorssOrigin`
- 在xml中配置 ：
    ```xml
    <mvc:cors>
    <mvc:mapping path="/ajax/*"
                 allowed-origins="*"
                 max-age="3600" />
    </mvc:cors>
    ```
- 修改responseHeader： 

    ```java
    response.setHeader("Access-Control-Allow-Origin",request.getHeader("origin"));
    response.setHeader("Access-Control-Allow-Methods", "*");
    response.setHeader("Access-Control-Allow-Credentials", "true");
    ```


前端采用jsonp方式访问接口，因此后端需要支持jsonp服务

spring4可以非常友好的做到支持jsonp的接口了，只需要如下新增一个JsonpAdvie即可，如下：

```java
@ControllerAdvice
public class JsonpAdvice extends AbstractJsonpResponseBodyAdvice {    
  public JsonpAdvice() {        
    super("callback");    
  }
}
```

#### 3. 服务接口

接下来就到了Controller接口了，一般的写法如下

```java
@RequestMapping(value = {"index", "/"}, method = RequestMethod.GET)
public String index(Map<String, Object> map) {
    return "index";
}

@RequestMapping(value = {"index2"}, method = RequestMethod.GET)
@ResponseBody
public String index2(Map<String, Object> map) {
    return "index";
}
```

上面两方法，实际上有不少的讲究

- 返回view页面，返回数据的两种方式
- 如何获取请求中的参数
- 如何将参数传递给返回的页面
- url匹配原则（如果两个方法都匹配同一个路径怎么办？）
- 请求方法限制（不显示指定method值时，表示支持哪些请求方法呢）

#### 4. 自定义异常界面
> 要实现我们自定义的嗯4xx,5xx界面，这是一个比较常见的需求了，可以如何处理


#### 5. 拦截服务内部异常堆栈
> 编写的代码，基本上要杜绝bug是不太可能的，如果出现了异常，而且将完整的堆栈信息直接抛给了前端，就不太友好了，因此如何处理这种情况呢？

#### 6. 参数校验和返回数据封装

我个人坚守的一个原则：

不要完全相信前端传输的参数，返回的数据请确保有意义

因为你完全不知道前端是在什么场景下，基于什么样的心里来调用你的服务，所以，请校验前端发起的参数，是否满足你的需求；

返回的数据，最好包含一个状态码，是响应成功，还是有什么异常，不同的异常，定义不同的状态码，方便后续问题定位和调试


#### 7. 后端做302重定向

这种场景出现得不多，一般常见的就是用户未登录，重定向到登录页面（常是前端来做，后端也可以）；确认收货之后跳入评价页面也是一个302跳转

---

### II. service层
> service层主要实现业务逻辑的封装，下于Dao层打交道，获取or写入DB数据；上于web层交互，返回前端需要的数据信息

#### 1. rpc服务依赖
> 通常不会把所有的服务都放在一起，而是会根据不同的业务进行拆分，每个业务会独立提供服务，服务与服务之间通过rpc调用

常见的rpc框架：`springcloud`, `dubbo`

对第三方服务的依赖，有几个使用方面的建议
 
 - 将rpc调用放在`try,catch`语句块中，确保不会被依赖服务的异常搞死自己
 - 尽量不要直接使用依赖服务返回的DO对象，最好转换为自定义的BO对象，这样别人的服务发生修改，返回数据结构变动后，对自己的业务影响就可以做到最小


#### 2. 超时设置

依赖第三方服务，有必要做好超时设置，如果对方死掉了，确保自己不会被拖死


#### 3. 限流控制

限流，可以区分为来源限流和调用限流，评估自己服务的性能，做好限流保护；对第三方的服务依赖，也做好限流配置，不会把别人玩死


常见的限流策略：

- 漏桶算法
- 令牌桶算法

可参考的开源包： guava

#### 4. 动态配置

动态配置，可以获取一些动态可实时改变的配置信息，可用于做一些预案、业务上的灰度开关等，基本上可算是一个后端服务不可缺少的组建

可参考的工具: 淘宝的`diamond`


#### 5. 数据同步
主要用于多应用、多服务器之间，需要同步某些信息的场景

可以借助上面的动态配置来实现，所有需要同步的机器，都监听一个配置信息，当配置信息发生变动时，会将新的数据同步所有的机器，间接实现了数据同步的功能

#### 6. 性能提高篇缓存
> 缓存是后端服务不可缺少的一个工具了，极大的提高服务性能

常用的缓存redis, memcache

#### 7. 消息总线
> 这个可以根据范围来划分，分为应用内的消息事件；和异步的消息总线

应用内的消息事件：

假设一个上传图片的服务，用户上传完毕之后，立马返回，但是发送一个消息，用于应用内上传图片计数+1（实际上不会这么简单的来计数，本处只做演示），可以采用EventBus来做这个


应用无关的消息总线：

这种主要是一些业务消息报相关操作了，比如新添加一个商品，反垃圾的团队监听这个消息报用于反垃圾检测处理；商品搜索的同学将这个商品加入搜索引擎；计数的同学，实现各种数据统计；审核的同学，将商品放入审核池...

这种较重的消息，可选择的 `kafaka`, `rabbitmq`, `rocketmq`等

#### 8. 重试机制
> 某些服务比较重要，某次失败了需要进行重试

比如下单减库存，结果发现调用库存的服务超时了，这时就可以重试一次，要知道每次下单都是真贵的，不要随便就放弃掉；那么一个优雅的重试机制就比较重要了

#### 9. 信息埋点上报
> 服务的性能监控，记录每个服务的qps，rt，异常情况


#### 10. 日志平台
> 业务日志分析，异常日志分析平台

logstash, kibana 搭建日志收集查询平台

#### 11. 报警

如果业务异常，但是码农都放假了，怎么办？所以一个中，报警是不可缺少的，如果出现了问题

常见的报警有：短信，微信，邮件

#### 12. 服务监控

判断服务是否正常可用的手段；如http服务，隔一段时间调用一下，判断http服务是否正常，如果不正常（如机器故障），则自动下线

---

### III. dao层
> dao层主要用于db的交互，可用的技术栈较多，下面以我个人接触最多的场景进行分析

技术栈

MySQL + myBatis 

#### 1. 分布式锁

计数服务时，最怕的就是并发导致计数有问题，分布式锁用处比较多了

#### 2. 事务机制

太典型了，以至于没什么好说的了

#### 3. 分库分表

分库分表的方案，如何实现跨表查询等



---

### IV. 其他

除了上面的基本服务之外，还会要大量配套的服务设施，下面给出一些常见的服务

#### 1. 数据订正

如何优雅的实现数据订正? 每次都进行ddl？

#### 2. 扫表

扫表做数据分析，如分析评价文本，判断用户的购买倾向，可以怎样实现优雅的扫表功能呢？

#### 3. 数据迁移

单库单表 -> 多库多表，就会涉及到数据迁移，如何优雅的支持？

#### 4. 数据对账

如何确保缓存中的数据和db完全一致？数据对账的必要性就出来了

#### 5. 延迟队列

上面的对账一般不是实时做的，会有一定的延时，然后再进行对账，所以一个延迟队列就有必要了

#### 6. 定时任务

定时任务 quartz

简单的也可以用 spring-schedule

#### 7. 消息消费

前面说了发送一些kafaka, mq消息，然后就必然有消息消费的任务了，一般而言，消息消费的前期准备，环境、数据解析，返回等都是一样的，唯一不同的就是消息的使用了

所以，一个公共的平台，提供统一的消息消费任务的执行，就很有必要了，在这个平台上，你只需要简单的消费的数据源，然后平台将数据传递给你，使用者只需要完成相依的业务功能，不用关注其他的对接和返回过程
