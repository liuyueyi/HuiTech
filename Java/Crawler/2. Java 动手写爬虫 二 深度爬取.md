# ç¬¬äºŒç¯‡ï¼Œæ·±åº¦çˆ¬å–
> å‰é¢å®ç°äº†ä¸€ä¸ªæœ€åŸºç¡€çš„çˆ¬å–å•ç½‘é¡µçš„çˆ¬è™«ï¼Œè¿™ä¸€ç¯‡åˆ™ç€æ‰‹è§£å†³æ·±åº¦çˆ¬å–çš„é—®é¢˜
> 
> ç®€å•æ¥è®²ï¼Œå°±æ˜¯çˆ¬äº†ä¸€ä¸ªç½‘é¡µä¹‹åï¼Œç»§ç»­çˆ¬è¿™ä¸ªç½‘é¡µä¸­çš„é“¾æ¥

## 1. éœ€æ±‚èƒŒæ™¯

èƒŒæ™¯æ¯”è¾ƒç®€å•å’Œæ˜ç¡®ï¼Œå½“çˆ¬äº†ä¸€ä¸ªç½‘é¡µä¹‹åï¼Œç›®æ ‡æ˜¯ä¸è¦å°±æ­¤æ‰“ä½ï¼Œæ‰«æè¿™ä¸ªç½‘é¡µä¸­çš„é“¾æ¥ï¼Œç»§ç»­çˆ¬ï¼Œæ‰€ä»¥æœ‰å‡ ä¸ªç‚¹éœ€è¦è€ƒè™‘:

- å“ªäº›é“¾æ¥å¯ä»¥ç»§ç»­çˆ¬ ï¼Ÿ
- æ˜¯å¦è¦ä¸€ç›´çˆ¬ä¸‹å»ï¼Œè¦ä¸è¦ç»™ä¸€ä¸ªç»ˆæ­¢ç¬¦ï¼Ÿ
- æ–°çš„é“¾æ¥ä¸­ï¼Œæå–å†…å®¹çš„è§„åˆ™å’Œå½“å‰ç½‘é¡µçš„è§„åˆ™ä¸ä¸€è‡´å¯ä»¥æ€ä¹ˆåŠï¼Ÿ

## 2. è®¾è®¡

é’ˆå¯¹ä¸Šé¢çš„å‡ ç‚¹ï¼Œç»“åˆä¹‹å‰çš„å®ç°ç»“æ„ï¼Œåœ¨æ‰§è¡Œ `doFetchPage` æ–¹æ³•è·å–ç½‘é¡µä¹‹åï¼Œè¿˜å¾—åšä¸€äº›å…¶ä»–çš„æ“ä½œ

- æ‰«æç½‘é¡µä¸­çš„é“¾æ¥ï¼Œæ ¹æ®è¿‡æ»¤è§„åˆ™åŒ¹é…æ»¡è¶³è¦æ±‚çš„é“¾æ¥
- è®°å½•ä¸€ä¸ªdepthï¼Œç”¨äºè¡¨ç¤ºçˆ¬å–çš„æ·±åº¦ï¼Œå³ä»æœ€åŸå§‹çš„ç½‘é¡µå‡ºå‘ï¼Œåˆ°å½“å‰é¡µé¢ä¸­é—´è½¬äº†å‡ æ¬¡ï¼ˆè®²åˆ°è¿™é‡Œå°±æœ‰ä¸ªå¾ªç¯çˆ¬å–çš„é—®é¢˜ï¼Œåé¢è¯´ï¼‰
- ä¸åŒçš„é¡µé¢æå–å†…å®¹è§„åˆ™ä¸ä¸€æ ·ï¼Œå› æ­¤å¯ä»¥è€ƒè™‘ç•™ä¸€ä¸ªæ¥å£å‡ºæ¥ï¼Œè®©é€‚ç”¨æ–¹è‡ªå·±æ¥å®ç°è§£æç½‘é¡µå†…å®¹


### åŸºæœ¬å®ç°
> å¼€å§‹ä¾ç„¶æ˜¯å…ˆæŠŠåŠŸèƒ½ç‚¹å®ç°ï¼Œç„¶åå†è€ƒè™‘å…·ä½“çš„ä¼˜åŒ–ç»†èŠ‚

å…ˆåŠ ä¸€ä¸ªé…ç½®é¡¹ï¼Œè¡¨ç¤ºçˆ¬å–é¡µé¢æ·±åº¦; å…¶æ¬¡å°±æ˜¯ä¿å­˜çš„ç»“æœï¼Œå¾—æœ‰ä¸ªå®¹å™¨æ¥æš‚å­˜ï¼Œ æ‰€ä»¥åœ¨ `SimpleCrawlJob` ä¼šæ–°å¢ä¸¤ä¸ªå±æ€§

```java
/**
 * æ‰¹é‡æŸ¥è¯¢çš„ç»“æœ
 */
private List<CrawlResult> crawlResults = new ArrayList<>();


/**
 * çˆ¬ç½‘é¡µçš„æ·±åº¦, é»˜è®¤ä¸º0ï¼Œ å³åªçˆ¬å–å½“å‰ç½‘é¡µ
 */
private int depth = 0;
```


å› ä¸ºæœ‰æ·±åº¦çˆ¬å–çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸€ä¸‹çˆ¬å–ç½‘é¡µçš„ä»£ç ï¼Œæ–°å¢ä¸€ä¸ª `doFetchNetxtPage`æ–¹æ³•ï¼Œè¿›è¡Œè¿­ä»£çˆ¬å–ç½‘é¡µï¼Œè¿™æ—¶ï¼Œç»“æœåŒ¹é…å¤„ç†æ–¹æ³•ä¹Ÿä¸èƒ½å¦‚ä¹‹å‰çš„ç›´æ¥èµ‹å€¼äº†ï¼Œç¨å¾®æ”¹ä¸€ä¸‹å³å¯, æ”¹æˆè¿”å›ä¸€ä¸ªæ¥è¿‡å®ä¾‹

```java
/**
 * æ‰§è¡ŒæŠ“å–ç½‘é¡µ
 */
public void doFetchPage() throws Exception {
    doFetchNextPage(0, this.crawlMeta.getUrl());
    this.crawlResult = this.crawlResults.get(0);
}


private void doFetchNextPage(int currentDepth, String url) throws Exception {
    HttpResponse response = HttpUtils.request(new CrawlMeta(url, this.crawlMeta.getSelectorRules()), httpConf);
    String res = EntityUtils.toString(response.getEntity());
    CrawlResult result;
    if (response.getStatusLine().getStatusCode() != 200) { // è¯·æ±‚æˆåŠŸ
        result = new CrawlResult();
        result.setStatus(response.getStatusLine().getStatusCode(), response.getStatusLine().getReasonPhrase());
        result.setUrl(crawlMeta.getUrl());
        this.crawlResults.add(result);
        return;
    }

    result = doParse(res);

    // è¶…è¿‡æœ€å¤§æ·±åº¦ï¼Œ ä¸ç»§ç»­çˆ¬
    if (currentDepth > depth) {
        return;
    }


    Elements elements = result.getHtmlDoc().select("a[href]");
    for(Element element: elements) {
        doFetchNextPage(currentDepth + 1, element.attr("href"));
    }
}


private CrawlResult doParse(String html) {
    Document doc = Jsoup.parse(html);
    
    Map<String, List<String>> map = new HashMap<>(crawlMeta.getSelectorRules().size());
    for (String rule : crawlMeta.getSelectorRules()) {
        List<String> list = new ArrayList<>();
        for (Element element : doc.select(rule)) {
            list.add(element.text());
        }
    
        map.put(rule, list);
    }
    
    
    CrawlResult result = new CrawlResult();
    result.setHtmlDoc(doc);
    result.setUrl(crawlMeta.getUrl());
    result.setResult(map);
    result.setStatus(CrawlResult.SUCCESS);
    return result;
}
```


#### è¯´æ˜

ä¸»è¦çš„å…³é”®ä»£ç åœ¨ `doFetchNextPage` ä¸­ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºå½“å‰urlå±äºçˆ¬å–çš„ç¬¬å‡ å±‚ï¼Œçˆ¬å®Œä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æ·±åº¦ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è·å–å‡ºç½‘é¡µä¸­çš„æ‰€æœ‰é“¾æ¥ï¼Œè¿­ä»£è°ƒç”¨ä¸€é


ä¸‹é¢ä¸»è¦æ˜¯è·å–ç½‘é¡µä¸­çš„è·³è½¬é“¾æ¥ï¼Œç›´æ¥ä»jsoupçš„æºç ä¸­çš„exampleä¸­è·å–ï¼Œè·å–ç½‘é¡µä¸­é“¾æ¥çš„æ–¹æ³•

```java
// æœªè¶…è¿‡æœ€å¤§æ·±åº¦ï¼Œ ç»§ç»­çˆ¬ç½‘é¡µä¸­çš„æ‰€æœ‰é“¾æ¥
result = doParse(res);
Elements elements = result.getHtmlDoc().select("a[href]");
for(Element element: elements) {
    doFetchNextPage(currentDepth + 1, element.attr("href"));
}
```



#### æµ‹è¯•case

æµ‹è¯•ä»£ç å’Œä¹‹å‰çš„å·®ä¸å¤šï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯æŒ‡å®šäº†çˆ¬å–çš„æ·±åº¦ï¼Œè¿”å›ç»“æœå°±ä¸æˆªå›¾äº†ï¼Œå®åœ¨æ˜¯æœ‰ç‚¹å¤š

```java
/**
 * æ·±åº¦çˆ¬
 * @throws InterruptedException
 */
@Test
public void testDepthFetch() throws InterruptedException {
    String url = "https://my.oschina.net/u/566591/blog/1031575";
    CrawlMeta crawlMeta = new CrawlMeta();
    crawlMeta.setUrl(url);


    SimpleCrawlJob job = new SimpleCrawlJob(1);
    job.setCrawlMeta(crawlMeta);
    Thread thread = new Thread(job, "crawlerDepth-test");
    thread.start();


    thread.join();
    List<CrawlResult> result = job.getCrawlResults();
    System.out.println(result);
}
```

## 3. æ”¹è¿›

### é—®é¢˜

ä¸Šé¢è™½ç„¶æ˜¯å®ç°äº†ç›®æ ‡ï¼Œä½†é—®é¢˜å´æœ‰ç‚¹å¤šï¼š

- å°±æ¯”å¦‚ä¸Šé¢çš„æµ‹è¯•caseï¼Œå‘ç°æœ‰122ä¸ªè·³è½¬é“¾æ¥ï¼Œé¡ºåºçˆ¬é€Ÿåº¦æœ‰ç‚¹æ…¢

  ![14987169282459.jpg](quiver-image-url/7F7DBA4CB47E3AA0F4C1F1A8AAAC829B.jpg)
  
- é“¾æ¥ä¸­å­˜åœ¨é‡å¤ã€é¡µé¢å†…é”šç‚¹ã€jsç­‰å„ç§æƒ…å†µï¼Œå¹¶ä¸æ˜¯éƒ½æ»¡è¶³éœ€æ±‚
- æœ€åçš„ç»“æœå¡åˆ°Listä¸­ï¼Œæ·±åº¦è¾ƒå¤šæ—¶ï¼Œé“¾æ¥è¾ƒå¤šæ—¶ï¼Œlistå¯èƒ½è¢«æ’‘æš´


### - æ·»åŠ é“¾æ¥çš„è¿‡æ»¤
> è¿‡æ»¤è§„åˆ™ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºä¸¤ç§ï¼Œæ­£å‘çš„åŒ¹é…ï¼Œå’Œé€†å‘çš„æ’é™¤

é¦–å…ˆæ˜¯ä¿®æ”¹é…ç½®ç±» `CrawlMeta`ï¼Œ æ–°å¢ä¸¤ä¸ªé…ç½®

```java
/**
 * æ­£å‘çš„è¿‡æ»¤è§„åˆ™
 */
@Setter
@Getter
private Set<Pattern> positiveRegex = new HashSet<>();


/**
 * é€†å‘çš„è¿‡æ»¤è§„åˆ™
 */
@Setter
@Getter
private Set<Pattern> negativeRegex = new HashSet<>();


public Set<Pattern> addPositiveRegex(String regex) {
    this.positiveRegex.add(Pattern.compile(regex));
    return this.positiveRegex;
}


public Set<Pattern> addNegativeRegex(String regex) {
    this.negativeRegex.add(Pattern.compile(regex));
    return this.negativeRegex;
}
```


ç„¶ååœ¨éå†å­é“¾æ¥æ—¶ï¼Œåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ»¡è¶³éœ€æ±‚


```java
// doFetchNextPage æ–¹æ³•

Elements elements = result.getHtmlDoc().select("a[href]");
String src;
for(Element element: elements) {
    src = element.attr("href");
    if (matchRegex(src)) {
        doFetchNextPage(currentDepth + 1, element.attr("href"));
    }
}



// è§„åˆ™åŒ¹é…æ–¹æ³•
private boolean matchRegex(String url) {
    Matcher matcher;
    for(Pattern pattern: crawlMeta.getPositiveRegex()) {
        matcher = pattern.matcher(url);
        if (matcher.find()) {
            return true;
        }
    }


    for(Pattern pattern: crawlMeta.getNegativeRegex()) {
        matcher = pattern.matcher(url);
        if(matcher.find()) {
            return false;
        }
    }


    return crawlMeta.getPositiveRegex().size() == 0;
}
```

ä¸Šé¢ä¸»è¦æ˜¯é€šè¿‡æ­£åˆ™æ¥è¿›è¡Œè¿‡æ»¤ï¼Œæš‚ä¸è€ƒè™‘æ­£åˆ™å¸¦æ¥çš„å¼€é”€é—®é¢˜ï¼Œè‡³å°‘æ˜¯è§£å†³äº†ä¸€ä¸ªè¿‡æ»¤çš„é—®é¢˜

ä½†æ˜¯ï¼Œä½†æ˜¯ï¼Œå¦‚æœç½‘é¡µä¸­çš„é“¾æ¥æ˜¯ç›¸å¯¹è·¯å¾„çš„è¯ï¼Œä¼šæ€ä¹ˆæ ·


ç›´æ¥ä½¿ç”¨ Jsoupæ¥æµ‹è¯•ä¸€ä¸ªç½‘é¡µï¼Œçœ‹è·å–çš„linkåœ°å€ä¸ºä»€ä¹ˆ

```java
// è·å–ç½‘é¡µä¸­çš„æ‰€æœ‰é“¾æ¥
@Test
public void testGetLink() throws IOException {
    String url = "http://chengyu.911cha.com/zishu_3_p1.html";

    Connection httpConnection = HttpConnection.connect(url)
            .header("accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8")
            .header("connection", "Keep-Alive")
            .header("user-agent", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36");

    Document doc = httpConnection.get();
    Elements links = doc.select("a[href]");

    print("\nLinks: (%d)", links.size());
}
```

çœ‹ä¸‹å–å‡ºçš„é“¾æ¥

![1.png](quiver-image-url/B2097178D923508A29EE373957A5E531.png)



æ ¹æ®ä¸Šé¢çš„æµ‹è¯•ï¼Œè·å–çš„é“¾æ¥å¦‚æœæ˜¯ç›¸å¯¹åœ°å€ï¼Œåˆ™ä¼šæœ‰é—®é¢˜ï¼Œéœ€è¦æœ‰ä¸€ä¸ªè½¬åŒ–çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªæ”¹åŠ¨æ¯”è¾ƒç®€å•ï¼Œjsoupæœ¬èº«æ˜¯æ”¯æŒçš„

æ”¹ä¸€è¡Œå³å¯


```java
// è§£æä¸ºdocumnetå¯¹è±¡æ—¶ï¼ŒæŒ‡å®š baseUrl
// ä¸Šé¢çš„ä»£ç ç»“æ„ä¼šåšä¸€ç‚¹ä¿®æ”¹ï¼Œåé¢ä¼šè¯´åˆ°
Document doc = Jsoup.parse(html, url);


// è·å–é“¾æ¥æ—¶ï¼Œå‰é¢æ·»åŠ abs
src = element.attr("abs:href");
```

![1.png](quiver-image-url/5E0821BC304F81AF9724E7D73BA5ABF1.png)


### - ä¿å­˜ç»“æœ

å½“çˆ¬å–çš„æ•°æ®é‡è¾ƒå¤šæ—¶ï¼Œå°†ç»“æœéƒ½ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œå‡è‰²æ¯ä¸ªç½‘é¡µä¸­ï¼Œæ»¡è¶³è§„åˆ™çš„æ˜¯æœ‰10ä¸ªï¼Œé‚£ä¹ˆdepth=nï¼Œ åˆ™ä»ç¬¬ä¸€ä¸ªç½‘é¡µå‡ºå‘ï¼Œæœ€ç»ˆä¼šå¾—åˆ°

`1 + 10 + ... + 10^n = (10^(n+1) - 1) / 9`

æ˜¾ç„¶åœ¨å®é™…æƒ…å†µä¸­æ˜¯ä¸å¯å–çš„ï¼Œå› æ­¤å¯ä»¥æ”¹é€ ä¸€ä¸‹ï¼Œè·å–æ•°æ®åç»™ä¸€ä¸ªå›è°ƒï¼Œè®©ç”¨æˆ·è‡ªå·±æ¥é€‰æ‹©å¦‚ä½•å¤„ç†ç»“æœï¼Œè¿™æ—¶ `SimpleCrawelJob` çš„ç»“æ„åŸºæœ¬ä¸Šæ»¡è¶³ä¸äº†éœ€æ±‚äº†

é‡æ–°å¼€å§‹è®¾è®¡


#### 1. `AbstractJob` ç±»ä¸­å®šä¹‰ä¸€ä¸ªå›è°ƒæ–¹æ³•

```java
/**
 * è§£æå®Œç½‘é¡µåçš„å›è°ƒæ–¹æ³•
 *
 * @param crawlResult
 */
protected abstract void visit(CrawlResult crawlResult);
```


#### 2. `DefaultAbstractCrawlJob` å®ç°çˆ¬å–ç½‘é¡µé€»è¾‘çš„æŠ½è±¡ç±»

è¿™ä¸ªç±»å®ç°çˆ¬å–ç½‘é¡µçš„ä¸»è¦é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯å°†ä¹‹å‰çš„`SimpleCrwalJob`çš„å®ç°æ‹·è´è¿‡æ¥ï¼ŒåŒºåˆ«æ˜¯å¹²æ‰äº†è¿”å›ç»“æœ; é¡ºå¸¦ä¿®äº†ä¸€ä¸ªå°bug ğŸ˜¢


```java
/**
 * Created by yihui on 2017/6/29.
 */
@Getter
@Setter
@NoArgsConstructor
public abstract class DefaultAbstractCrawlJob extends AbstractJob {
    /**
     * é…ç½®é¡¹ä¿¡æ¯
     */
    private CrawlMeta crawlMeta;


    /**
     * httpé…ç½®ä¿¡æ¯
     */
    private CrawlHttpConf httpConf = new CrawlHttpConf();


    /**
     * çˆ¬ç½‘é¡µçš„æ·±åº¦, é»˜è®¤ä¸º0ï¼Œ å³åªçˆ¬å–å½“å‰ç½‘é¡µ
     */
    protected int depth = 0;


    public DefaultAbstractCrawlJob(int depth) {
        this.depth = depth;
    }


    /**
     * æ‰§è¡ŒæŠ“å–ç½‘é¡µ
     */
    public void doFetchPage() throws Exception {
        doFetchNextPage(0, this.crawlMeta.getUrl());
    }


    private void doFetchNextPage(int currentDepth, String url) throws Exception {
        CrawlMeta subMeta = new CrawlMeta(url, this.crawlMeta.getSelectorRules(), this.crawlMeta.getPositiveRegex(), this.crawlMeta.getNegativeRegex());
        HttpResponse response = HttpUtils.request(subMeta, httpConf);
        String res = EntityUtils.toString(response.getEntity());
        CrawlResult result;
        if (response.getStatusLine().getStatusCode() != 200) { // è¯·æ±‚æˆåŠŸ
            result = new CrawlResult();
            result.setStatus(response.getStatusLine().getStatusCode(), response.getStatusLine().getReasonPhrase());
            result.setUrl(crawlMeta.getUrl());
            this.visit(result);
            return;
        }


        // ç½‘é¡µè§£æ
        result = doParse(res, subMeta);
        // å›è°ƒç”¨æˆ·çš„ç½‘é¡µå†…å®¹è§£ææ–¹æ³•
        this.visit(result);


        // è¶…è¿‡æœ€å¤§æ·±åº¦ï¼Œ ä¸ç»§ç»­çˆ¬
        if (currentDepth > depth) {
            return;
        }


        Elements elements = result.getHtmlDoc().select("a[href]");
        String src;
        for(Element element: elements) {
            // ç¡®ä¿å°†ç›¸å¯¹åœ°å€è½¬ä¸ºç»å¯¹åœ°å€
            src = element.attr("abs:href");
            if (matchRegex(src)) {
                doFetchNextPage(currentDepth + 1, src);
            }
        }
    }


    private CrawlResult doParse(String html, CrawlMeta meta) {
        // æŒ‡å®šbaseUrlï¼Œ å¦åˆ™åˆ©ç”¨ abs:href è·å–é“¾æ¥ä¼šå‡ºé”™
        Document doc = Jsoup.parse(html, meta.getUrl());

        Map<String, List<String>> map = new HashMap<>(meta.getSelectorRules().size());
        for (String rule : crawlMeta.getSelectorRules()) {
            List<String> list = new ArrayList<>();
            for (Element element : doc.select(rule)) {
                list.add(element.text());
            }

            map.put(rule, list);
        }


        CrawlResult result = new CrawlResult();
        result.setHtmlDoc(doc);
        result.setUrl(meta.getUrl());
        result.setResult(map);
        result.setStatus(CrawlResult.SUCCESS);
        return result;
    }


    private boolean matchRegex(String url) {
        Matcher matcher;
        for(Pattern pattern: crawlMeta.getPositiveRegex()) {
            matcher = pattern.matcher(url);
            if (matcher.find()) {
                return true;
            }
        }


        for(Pattern pattern: crawlMeta.getNegativeRegex()) {
            matcher = pattern.matcher(url);
            if(matcher.find()) {
                return false;
            }
        }


        return crawlMeta.getPositiveRegex().size() == 0;
    }
}

```


#### 3. `SimpleCrawlJob`

é‡å†™è¿™ä¸ªç®€å•çˆ¬è™«ä»»åŠ¡çš„å®ç°ï¼Œå› ä¸ºä¸»è¦é€»è¾‘åœ¨ `DefaultAbstractCrawlJob`ä¸­å·²ç»å®ç°äº†ï¼Œæ‰€ä»¥ç›´æ¥ç»§æ‰¿è¿‡æ¥å³å¯

ä¸»è¦å…³æ³¨çš„å°±æ˜¯ `visit` æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯çˆ¬å–ç½‘é¡µä¹‹åçš„å›è°ƒï¼Œè¿™ä¸ªæœ€ç®€å•çš„çˆ¬è™«ä»»åŠ¡ï¼Œå°±æ˜¯å°†ç»“æœä¿å­˜åœ¨å†…å­˜ä¸­

```java
/**
 * æœ€ç®€å•çš„ä¸€ä¸ªçˆ¬è™«ä»»åŠ¡
 * <p>
 * Created by yihui on 2017/6/27.
 */
@Getter
@Setter
@NoArgsConstructor
public class SimpleCrawlJob extends DefaultAbstractCrawlJob {

    /**
     * å­˜å‚¨çˆ¬å–çš„ç»“æœ
     */
    private CrawlResult crawlResult;


    /**
     * æ‰¹é‡æŸ¥è¯¢çš„ç»“æœ
     */
    private List<CrawlResult> crawlResults = new ArrayList<>();



    public SimpleCrawlJob(int depth) {
        super(depth);
    }


    @Override
    protected void visit(CrawlResult crawlResult) {
        crawlResults.add(crawlResult);
    }


    public CrawlResult getCrawlResult() {
        if(crawlResults.size() == 0) {
            return null;
        }

        return crawlResults.get(0);
    }
}
```


#### 4ï¼Œä½¿ç”¨æµ‹è¯•

å’Œä¹‹å‰æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œå…ˆæ¥ä¸ªç®€å•çš„


```java
@Test
public void testDepthFetch() throws InterruptedException {
    String url = "http://chengyu.911cha.com/zishu_3_p1.html";
    CrawlMeta crawlMeta = new CrawlMeta();
    crawlMeta.setUrl(url);
    crawlMeta.addPositiveRegex("http://chengyu.911cha.com/zishu_3_p([0-9]+).html");


    SimpleCrawlJob job = new SimpleCrawlJob(1);
    job.setCrawlMeta(crawlMeta);
    Thread thread = new Thread(job, "crawlerDepth-test");
    thread.start();


    thread.join();
    List<CrawlResult> result = job.getCrawlResults();
    System.out.println(result);
}
```

è¿è¡Œæˆªå›¾


![1.png](quiver-image-url/C3474AAE3DAE0C7AD76EC39AFB4B9113.png)



ç›´æ¥ä½¿ç”¨ `DefaultAbstractCrawl` æŠ½è±¡ç±»çš„å›è°ƒæ¥è¿›è¡Œæµ‹è¯•

```java
@Test
public void testSelfCwralFetch() throws InterruptedException {
    String url = "http://chengyu.911cha.com/zishu_3_p1.html";
    CrawlMeta crawlMeta = new CrawlMeta();
    crawlMeta.setUrl(url);
    crawlMeta.addPositiveRegex("http://chengyu.911cha.com/zishu_3_p([0-9]+).html");


    DefaultAbstractCrawlJob job = new DefaultAbstractCrawlJob(1) {
        @Override
        protected void visit(CrawlResult crawlResult) {
            System.out.println(crawlResult.getUrl());
        }
    };
    job.setCrawlMeta(crawlMeta);
    Thread thread = new Thread(job, "crawlerDepth-test");
    thread.start();

    thread.join();
    System.out.println("over");
}
```


### - çˆ¬è™«å»é‡
> ä»ä¸Šé¢å¯ä»¥å‘ç°ï¼Œé‡å¤çˆ¬å–æ˜¯æ¯”è¾ƒæµªè´¹çš„äº‹æƒ…ï¼Œå› æ­¤å»é‡æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼›ä¸€èˆ¬æƒ³æ³•æ˜¯å°†çˆ¬è¿‡çš„urléƒ½æ ‡è®°ä¸€ä¸‹ï¼Œæ¯æ¬¡çˆ¬ä¹‹å‰åˆ¤æ–­æ˜¯å¦å·²ç»çˆ¬è¿‡äº†

ä¾ç„¶å…ˆæ˜¯é‡‡ç”¨æœ€lowçš„æ–¹æ³•ï¼Œæä¸€ä¸ªSetæ¥è®°å½•æ‰€æœ‰çˆ¬å–çš„urlï¼Œå› ä¸ºå…·ä½“çš„çˆ¬è™«ä»»åŠ¡è®¾è®¡çš„æ˜¯å¤šçº¿ç¨‹çš„ï¼Œæ‰€ä»¥è¿™ä¸ªSetæ˜¯è¦æ±‚å¤šçº¿ç¨‹å…±äº«çš„


æ­¤å¤–è€ƒè™‘åˆ°å»é‡çš„æ‰‹æ®µæ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ç›®å‰è™½ç„¶åªæ˜¯é‡‡ç”¨çš„å†…å­˜ä¸­åŠ ä¸€ä¸ªç¼“å­˜è¡¨ï¼Œä½†ä¸å¦¨ç¢æˆ‘ä»¬è®¾è®¡çš„æ—¶å€™ï¼Œé‡‡ç”¨é¢å‘æ¥å£çš„æ–¹å¼


#### 1. `IStorage` æ¥å£
> æä¾›å­˜è®°å½•ï¼Œåˆ¤æ–­è®°å½•æ˜¯å¦å­˜åœ¨çš„æ–¹æ³•

```java
public interface IStorage {

    /**
     * è‹¥çˆ¬å–çš„URLä¸åœ¨storageä¸­ï¼Œ åˆ™å†™å…¥ï¼› å¦åˆ™å¿½ç•¥
     *
     * @param url çˆ¬å–çš„ç½‘å€
     * @return true è¡¨ç¤ºå†™å…¥æˆåŠŸï¼Œ å³ä¹‹å‰æ²¡æœ‰è¿™æ¡è®°å½•ï¼› false åˆ™è¡¨ç¤ºä¹‹å‰å·²ç»æœ‰è®°å½•äº†
     */
    boolean putIfNotExist(String url, CrawlResult result);


    /**
     * åˆ¤æ–­æ˜¯å¦å­˜åœ¨
     * @param url
     * @return
     */
    boolean contains(String url);

}
```


#### 2. `RamStorage` åˆ©ç”¨Mapå®ç°çš„å†…å­˜å­˜å‚¨

```java
public class RamStorage implements IStorage {

    private Map<String, CrawlResult> map = new ConcurrentHashMap<>();


    @Override
    public boolean putIfNotExist(String url, CrawlResult result) {
        if(map.containsKey(url)) {
            return false;
        }

        map.put(url, result);
        return true;
    }

    @Override
    public boolean contains(String url) {
        return map.containsKey(url);
    }
}
```


#### 3. `StorageWrapper` å°è£…ç±»
> è¿™ä¸ªå°è£…ç±»è¦æ±‚å¤šçº¿ç¨‹å…±äº«ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹

ä¸€ä¸ªæœ€åŸå§‹çš„å®ç°æ–¹å¼å¦‚ä¸‹(æš‚ä¸è€ƒè™‘å…¶ä¸­æ¯”è¾ƒçŒ¥ççš„storageå®ä¾‹åŒ–æ–¹å¼)

```java
public class StorageWrapper {

    private static StorageWrapper instance = new StorageWrapper();


    private IStorage storage;

    public static StorageWrapper getInstance() {
        return instance;
    }


    private StorageWrapper() {
        storage = new RamStorage();
    }


    /**
     * åˆ¤æ–­urlæ˜¯å¦è¢«çˆ¬å–è¿‡
     *
     * @param url
     * @return
     */
    public boolean ifUrlFetched(String url) {
        return storage.contains(url);
    }


    /**
     * çˆ¬å®Œä¹‹åï¼Œ æ–°å¢ä¸€æ¡çˆ¬å–è®°å½•
     * @param url
     * @param crawlResult
     */
    public void addFetchRecord(String url, CrawlResult crawlResult) {
        storage.putIfNotExist(url, crawlResult);
    }
}
```


è¿™æ ·ä¸€ä¸ªç®€å•çš„ä¿å­˜çˆ¬å–å†å²è®°å½•çš„å®¹å™¨å°±æœ‰äº†ï¼Œé‚£ä¹ˆåœ¨çˆ¬å–æ—¶ï¼Œå°±éœ€è¦äº‹å‰åˆ¤æ–­ä¸€ä¸‹

å¯¹åº”çš„ `DefaultAbstractCrawlJob#doFetchNextPage` æ–¹æ³•æ›´æ–°å¦‚ä¸‹

```java
// fixme éçº¿ç¨‹å®‰å…¨
private void doFetchNextPage(int currentDepth, String url) throws Exception {
    if (StorageWrapper.getInstance().ifUrlFetched(url)) {
        return;
    }


    CrawlMeta subMeta = new CrawlMeta(url, this.crawlMeta.getSelectorRules(), this.crawlMeta.getPositiveRegex(), this.crawlMeta.getNegativeRegex());
    HttpResponse response = HttpUtils.request(subMeta, httpConf);
    String res = EntityUtils.toString(response.getEntity());
    CrawlResult result;
    if (response.getStatusLine().getStatusCode() != HttpStatus.SC_OK) { // è¯·æ±‚æˆåŠŸ
        result = new CrawlResult();
        result.setStatus(response.getStatusLine().getStatusCode(), response.getStatusLine().getReasonPhrase());
        result.setUrl(crawlMeta.getUrl());
        this.visit(result);
        return;
    }


    // ç½‘é¡µè§£æ
    result = doParse(res, subMeta);
    StorageWrapper.getInstance().addFetchRecord(url, result);

    // å›è°ƒç”¨æˆ·çš„ç½‘é¡µå†…å®¹è§£ææ–¹æ³•
    this.visit(result);


    // è¶…è¿‡æœ€å¤§æ·±åº¦ï¼Œ ä¸ç»§ç»­çˆ¬
    if (currentDepth > depth) {
        return;
    }


    Elements elements = result.getHtmlDoc().select("a[href]");
    String src;
    for(Element element: elements) {
        // ç¡®ä¿å°†ç›¸å¯¹åœ°å€è½¬ä¸ºç»å¯¹åœ°å€
        src = element.attr("abs:href");
        if (matchRegex(src)) {
            doFetchNextPage(currentDepth + 1, src);
        }
    }
}
```


å¦‚æœä»”ç»†çœ‹ä¸Šé¢çš„æ–¹æ³•ï¼Œå°±ä¼šå‘ç°åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¾ç„¶å¯èƒ½å­˜åœ¨é‡å¤çˆ¬å–çš„æƒ…å†µ


å¦‚æœ‰ä¸¤ä¸ª`CrawlJob`ä»»åŠ¡ï¼Œè‹¥çˆ¬å–çš„æ˜¯åŒä¸€ä¸ªurlï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡çˆ¬å–å®Œï¼Œè¿˜æ²¡æœ‰å›å†™åˆ°`Storage`æ—¶ï¼Œç¬¬äºŒä¸ªä»»åŠ¡å¼€å§‹çˆ¬ï¼Œè¿™æ—¶ï¼Œäº‹å‰åˆ¤æ–­æ²¡æœ‰è®°å½•ï¼Œç„¶åé€šè¿‡ä¹‹åå¼€å§‹çˆ¬ï¼Œè¿™æ—¶å°±ä¾ç„¶ä¼šå‡ºç°é‡å¤çˆ¬çš„é—®é¢˜


è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªç®€å•çš„æ–¹æ³•å°±æ˜¯åŠ é”ï¼Œåœ¨åˆ¤æ–­ä¸€ä¸ªurlæ²¡æœ‰è¢«çˆ¬æ—¶ï¼Œåˆ°å›å†™ä¸€æ¡çˆ¬å–ç»“æœè¿™æ®µæœŸé—´ï¼ŒåŠ ä¸€ä¸ªä¿æŠ¤é”

`StorageWrapper` æ›´æ–°åå¦‚ä¸‹

```java
/**
 * Created by yihui on 2017/6/29.
 */
public class StorageWrapper {

    private static StorageWrapper instance = new StorageWrapper();


    private IStorage storage;

    private Map<String, Lock> lockMap = new ConcurrentHashMap<>();

    public static StorageWrapper getInstance() {
        return instance;
    }


    private StorageWrapper() {
        storage = new RamStorage();
    }


    /**
     * åˆ¤æ–­urlæ˜¯å¦è¢«çˆ¬å–è¿‡; æ˜¯åˆ™è¿”å›trueï¼› å¦è¿™è¿”å›falseï¼Œ å¹¶ä¸Šé”
     *
     * @param url
     * @return
     */
    public boolean ifUrlFetched(String url) {
        if(storage.contains(url)) {
            return true;
        }

        synchronized (this) {
            if (!lockMap.containsKey(url)) {
                // ä¸å­˜åœ¨æ—¶ï¼ŒåŠ ä¸€ä¸ªé”
                lockMap.put(url, new ReentrantLock());
            }

            this.lock(url);


            if (storage.contains(url)) {
                return true;
            }
//            System.out.println(Thread.currentThread() + " lock url: " + url);
            return false;
        }
    }


    /**
     * çˆ¬å®Œä¹‹åï¼Œ æ–°å¢ä¸€æ¡çˆ¬å–è®°å½•
     * @param url
     * @param crawlResult
     */
    public void addFetchRecord(String url, CrawlResult crawlResult) {
        try {
            if (crawlResult != null) {
                storage.putIfNotExist(url, crawlResult);
                this.unlock(url);
            }
        } catch (Exception e) {
            System.out.println(Thread.currentThread().getName() + " result: " + url + " e: " + e);
        }
    }



    private void lock(String url) {
        lockMap.get(url).lock();
    }


    private void unlock(String url) {
        lockMap.get(url).unlock();
    }
}

```


ä½¿ç”¨å¤„ï¼Œç¨ç¨å˜åŠ¨å¦‚ä¸‹

```java
private void doFetchNextPage(int currentDepth, String url) throws Exception {
    CrawlResult result = null;
    try {
        // åˆ¤æ–­æ˜¯å¦çˆ¬è¿‡ï¼›æœªçˆ¬å–ï¼Œåˆ™ä¸Šé”å¹¶ç»§ç»­çˆ¬å–ç½‘é¡µ
        if (StorageWrapper.getInstance().ifUrlFetched(url)) {
            return;
        }

        CrawlMeta subMeta = new CrawlMeta(url, this.crawlMeta.getSelectorRules(), this.crawlMeta.getPositiveRegex(), this.crawlMeta.getNegativeRegex());
        HttpResponse response = HttpUtils.request(subMeta, httpConf);
        String res = EntityUtils.toString(response.getEntity());
        if (response.getStatusLine().getStatusCode() != HttpStatus.SC_OK) { // è¯·æ±‚æˆåŠŸ
            result = new CrawlResult();
            result.setStatus(response.getStatusLine().getStatusCode(), response.getStatusLine().getReasonPhrase());
            result.setUrl(crawlMeta.getUrl());
            this.visit(result);
            return;
        }


        // ç½‘é¡µè§£æ
        result = doParse(res, subMeta);
    } finally {
        // æ·»åŠ ä¸€æ¡è®°å½•ï¼Œ å¹¶é‡Šæ”¾é”
        StorageWrapper.getInstance().addFetchRecord(url, result);
    }

    // å›è°ƒç”¨æˆ·çš„ç½‘é¡µå†…å®¹è§£ææ–¹æ³•
    this.visit(result);


    // è¶…è¿‡æœ€å¤§æ·±åº¦ï¼Œ ä¸ç»§ç»­çˆ¬
    if (currentDepth > depth) {
        return;
    }


    Elements elements = result.getHtmlDoc().select("a[href]");
    String src;
    for(Element element: elements) {
        // ç¡®ä¿å°†ç›¸å¯¹åœ°å€è½¬ä¸ºç»å¯¹åœ°å€
        src = element.attr("abs:href");
        if (matchRegex(src)) {
            doFetchNextPage(currentDepth + 1, src);
        }
    }
}
```


#### 4. æµ‹è¯•


```java
@Test
public void testSelfCwralFetch() throws InterruptedException {
    String url = "http://chengyu.t086.com/gushi/1.htm";
    CrawlMeta crawlMeta = new CrawlMeta();
    crawlMeta.setUrl(url);
    crawlMeta.addPositiveRegex("http://chengyu.t086.com/gushi/[0-9]+\\.htm$");


    DefaultAbstractCrawlJob job = new DefaultAbstractCrawlJob(1) {
        @Override
        protected void visit(CrawlResult crawlResult) {
            System.out.println("job1 >>> " + crawlResult.getUrl());
        }
    };
    job.setCrawlMeta(crawlMeta);



    String url2 = "http://chengyu.t086.com/gushi/2.htm";
    CrawlMeta crawlMeta2 = new CrawlMeta();
    crawlMeta2.setUrl(url2);
    crawlMeta2.addPositiveRegex("http://chengyu.t086.com/gushi/[0-9]+\\.htm$");
    DefaultAbstractCrawlJob job2 = new DefaultAbstractCrawlJob(1) {
        @Override
        protected void visit(CrawlResult crawlResult) {
            System.out.println("job2 >>> " + crawlResult.getUrl());
        }
    };
    job2.setCrawlMeta(crawlMeta2);



    Thread thread = new Thread(job, "crawlerDepth-test");
    Thread thread2 = new Thread(job2, "crawlerDepth-test2");
    thread.start();
    thread2.start();


    thread.join();
    thread2.join();
}
```

è¾“å‡ºå¦‚ä¸‹

```
job2 >>> http://chengyu.t086.com/gushi/2.htm
job1 >>> http://chengyu.t086.com/gushi/1.htm
job1 >>> http://chengyu.t086.com/gushi/3.htm
job2 >>> http://chengyu.t086.com/gushi/4.htm
job1 >>> http://chengyu.t086.com/gushi/5.htm
job1 >>> http://chengyu.t086.com/gushi/6.htm
job1 >>> http://chengyu.t086.com/gushi/7.htm
```

---

## å°ç»“

è¿™ä¸€ç¯‡çš„åšæ–‡æœ‰ç‚¹å¤šï¼Œåˆ°è¿™é‡Œå…¶å®ä¸Šé¢ä¸€äº›æå‡ºçš„é—®é¢˜è¿˜æ²¡æœ‰è§£å†³ï¼Œç•™å¾…ä¸‹ä¸€ç¯‡åšæ–‡æ¥fixæ‰, ä¸‹é¢åˆ™ä¸»è¦è¯´æ˜ä¸‹æœ¬ç¯‡çš„è¦ç‚¹

1. æ·±åº¦çˆ¬å–

  è¿™é‡Œä½¿ç”¨äº†è¿­ä»£çš„æ€è·¯ï¼Œçˆ¬åˆ°ä¸€ä¸ªç½‘é¡µä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åœæ­¢ï¼Œä¸åœæ­¢ï¼Œåˆ™æŠŠè¯¥ç½‘é¡µä¸­çš„é“¾æ¥æå‡ºæ¥ï¼Œç»§ç»­çˆ¬ï¼›å…³é”®ç‚¹
  
  - åˆ©ç”¨ Jsoup è·å–ç½‘é¡µä¸­æ‰€æœ‰é“¾æ¥ï¼ˆæ³¨æ„ç›¸å¯¹è·¯å¾„è½¬ç»å¯¹è·¯å¾„çš„ç”¨æ³•ï¼‰
  - å¾ªç¯è¿­ä»£

2. è¿‡æ»¤

  è¿‡æ»¤ï¼Œä¸»è¦åˆ©ç”¨æ­£åˆ™æ¥åŒ¹é…é“¾æ¥ï¼›è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹
  
    - æ­£å‘è¿‡æ»¤
    - è´Ÿå‘è¿‡æ»¤

3. å»é‡

  å¦‚ä½•ä¿è¯ä¸€ä¸ªé“¾æ¥è¢«çˆ¬äº†ä¹‹åï¼Œä¸ä¼šè¢«é‡å¤è¿›è¡Œçˆ¬å–ï¼Ÿ
  
    - è®°å½•çˆ¬å–å†å²
    - æ³¨æ„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜
    - åŠ é”ï¼ˆä¸€æŠŠé”ä¼šå¯¼è‡´æ€§èƒ½é™ä½ï¼Œè¿™é‡Œé‡‡ç”¨äº†ä¸€ä¸ªurlå¯¹åº”ä¸€ä¸ªé”ï¼Œæ³¨æ„çœ‹å®ç°ç»†èŠ‚ï¼Œè¾ƒå¤šçš„å‘ï¼‰
    
    
    
**é—ç•™é—®é¢˜**

1. å¤±è´¥é‡è¯•
2. çˆ¬ç½‘é¡µä¸­é“¾æ¥ä¸åº”è¯¥ä¸²è¡Œè¿›è¡Œ
3. é¢‘ç‡æ§åˆ¶ï¼ˆå¤ªå¿«å¯èƒ½ä¼šè¢«åæ‰’å¹²æ‰ï¼‰




æºç åœ°å€ï¼š https://github.com/liuyueyi/quick-crawler/releases/tag/v0.003

å¯¹åº”tag ï¼š[v0.003](https://github.com/liuyueyi/quick-crawler/releases/tag/v0.003)