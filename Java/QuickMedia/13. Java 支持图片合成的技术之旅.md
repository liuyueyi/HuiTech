## å›¾ç‰‡åˆæˆçš„å‰ä¸–ä»Šç”Ÿ
> ä½œä¸ºä¸€ä¸ªåç«¯ï¼Œä¸ºä»€ä¹ˆè¦åšå›¾ç‰‡åˆæˆï¼Ÿä¸ºä»€ä¹ˆè¦å®ç°ç±»xmlæ ‡è®°è¯­è¨€çš„æ¸²æŸ“ï¼Ÿ

æœ¬ç‰‡åšæ–‡å‡†å¤‡è¯¦ç»†çš„è®°å½•ä¸€ä¸‹ï¼Œä¸€ä¸ªjavaåç«¯å¦‚ä½•å»æ”¯æŒå›¾ç‰‡åˆæˆï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­é‡‡ç”¨äº†å“ªäº›çŒ¥ççš„æ–¹æ¡ˆï¼Œåˆé‡åˆ°äº†å“ªäº›é¬¼ç•œçš„é—®é¢˜

## I. èƒŒæ™¯

### 0. æ— èŠçš„æŠ€æœ¯ç ”ç©¶

æœ€å¼€å§‹èŒå‘æ”¯æŒå›¾ç‰‡åˆæˆçš„æƒ³æ³•ï¼Œé‚£æ—¶å€™è¿˜æ˜¯åœ¨åšäºŒç»´ç çš„æ—¶å€™ï¼Œç”¨äº†ä¸€äº›awtçš„ç”»å›¾å·¥å…·ï¼Œæ„Ÿè§‰è¿˜æŒºæœ‰æ„æ€çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå’Œå½“å‰çš„ç”µå•†ä¸»æµå®Œå…¨ä¸æ­è¾¹çš„æŠ€æœ¯åˆ†æ”¯ï¼Œå¼€å§‹ç”¨çš„æ—¶å€™æ„Ÿæ…¨ï¼Œè¿™ä¸œè¥¿ç‰›é€¼äº†ï¼Œä»€ä¹ˆéƒ½å¯ä»¥å¹²ï¼ˆè™½ç„¶æ“ä½œéå¸¸ä¸å‹å¥½ï¼‰ï¼Œå†åŠ ä¸Šç”¨åˆ°æœ‰é“äº‘ï¼Œå®ƒçš„ä¼šå‘˜åŠŸèƒ½æ”¯æŒåŠ åŠŸèƒ½å°†ç¬”è®°ä»¥å›¾ç‰‡æ–¹å¼ç”Ÿæˆï¼Œæ‰€ä»¥å°±æœ‰ä¸ªæƒ³æ³•ï¼Œjavaåç«¯èƒ½ä¸èƒ½æ”¯æŒmarkdownè¾“å‡ºå›¾ç‰‡å‘¢ï¼Ÿ

### 1. è›‹ç–¼çš„å°ç¨‹åº

ä¸æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å°ç¨‹åºå¼€å‘è€…ï¼Œè™½ç„¶å†™è¿‡ä¸€ä¸ªå°ç¨‹åºï¼Œä½†æ˜¯å¾ˆå¤šç‰¹æ€§ä¾ç„¶ä¸çŸ¥é“ï¼›

çªç„¶å¾ˆå¤šå‰ç«¯çªç„¶æäº†è¿™ä¹ˆä¸€ä¸ªéœ€æ±‚ï¼Œè¦æ±‚åç«¯æ”¯æŒå›¾ç‰‡åˆæˆï¼Œç”¨äºåˆ†äº«åˆ°æœ‹å‹åœˆ

è‡³äºåŸå› :

- æœ‰çš„è¯´å°ç¨‹åºæ²¡æœ‰æä¾›æˆªå±æ¥å£
- å°ç¨‹åºä¸æ”¯æŒç»˜å›¾ï¼ˆè¿™ä¸ªæˆ‘ä¸å¤ªç¡®å®šçœŸå®æ€§ï¼‰
- å°ç¨‹åºç»˜å›¾çš„apiä¸å¯æ§ï¼ˆå¦‚æœä»–ä»¬æœ‰bugï¼Œæˆ‘ä»¬å°±æ²¡æ³•ç©äº†ï¼›å¯¹æ­¤æˆ‘çš„çœ‹æ³•æ˜¯ï¼Œä½ æ•´ä¸ªä¸œè¥¿éƒ½æ˜¯åœ¨å°ç¨‹åºçš„ä½“ç³»é‡Œäº†ï¼Œè¦æ˜¯æœ‰ä¸ªä¸¥é‡bugï¼Œé‚£æˆ‘ä»¬çš„å°ç¨‹åºå¹²è„†å°±ä¸ç©å¥½äº†...ï¼‰
- å‰ç«¯è¿™ä¹ˆå¤šï¼Œæ¯ä¸ªäººéƒ½å»ç»˜åˆ¶ä¸€éä½æ•ˆï¼Œæœ‰ä¸ªåç«¯é€šç”¨çš„ï¼Œå„ä¸ªå¹³å°éƒ½é‡Šæ”¾äº†ï¼Œéƒ½å¯ä»¥ç›´æ¥ç”¨... (å¯¹æ­¤æˆ‘ä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œå¦‚æœæˆ‘æ˜¯å‰ç«¯æˆ‘ä¹ŸæŒºè¿™ä¸€ç‚¹ï¼›ç„¶è€Œæˆ‘ä¸æ˜¯ï¼Œæ‰€ä»¥æˆ‘æ‹’ç»ğŸ˜¢)

**å£°æ˜**

ä¸Šé¢æ‹¬å·çš„å†…å®¹çº¯ç²¹æ˜¯ä¸ªäººåæ§½ï¼Œæ²¡æœ‰ä»»ä½•åå‘æ€§ï¼Œ

### 2. å¼€åŠ¨

æœ‰éœ€æ±‚äº†ï¼Œå°±å¿…é¡»å»æ”¯æŒäº†ï¼Œè€Œä¸”ä»æŠ€æœ¯è§’åº¦å‡ºå‘ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„ç‚¹ï¼Œæ–°çš„æŒ‘æˆ˜ï¼Œå¯ä»¥ä¸€è¯•

## II. æŠ€æœ¯å°è¯•

ä¸ºäº†æ”¯æŒè¿™ä¸ªéœ€æ±‚ï¼Œå°è¯•äº†ä¸å°‘çš„æ‰‹æ®µï¼Œæ¥ä¸‹æ¥ä¸€ä¸€è¯´æ˜ï¼Œå½“ç„¶ç”±äºä¸ªäººè§è¯†æœ‰é™ï¼Œæœ€ç»ˆé€‰æ‹©çš„ä¹Ÿä¸ä¸€å®šæ˜¯å•¥å¥½ä¸œè¥¿ï¼Œç›®å‰ä¹Ÿåªæ˜¯å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œç¦»å‹å¥½æ”¯æŒï¼Œè¿˜æ¯”è¾ƒé¥è¿œ

### 0. javaçš„htmlæ¸²æŸ“åº“
> æœ€å…ˆæƒ³åˆ°çš„å°±æ˜¯è¿™ä¸ªï¼Œæœ‰æ²¡æœ‰ç›´æ¥å¯ä»¥æ¸²æŸ“çš„åº“ï¼Œå¤§Javaå·ç§°æ˜¯åœ¨githubä¸Šæ‹¥æœ‰æœ€å¤šå¼€æºå·¥å…·çš„è¯­è¨€

æŸ¥äº†ä¸€äº›å¼€æºåº“ï¼Œä¹Ÿä¸»åŠ¨å»å°è¯•è¿‡ä¸€äº›ï¼Œä¸‹é¢ç»™å‡ºä½¿ç”¨å§¿åŠ¿

#### a. html2image

ç›´æ¥åœ¨Githubä¸Šæœï¼Œæ‰¾ä¸€ä¸ªæœ€å¤šstarçš„å°±å¯ä»¥äº†ï¼Œæµ‹è¯•çš„æ¡†æ¶ 

- [java-html2image](https://github.com/hkirk/java-html2image)

æ¥å…¥åŠæµ‹è¯•æ–¹å¼

pmo ä¾èµ–å¼•å…¥

```xml
<dependency>
    <groupId>gui.ava</groupId>
    <artifactId>html2image</artifactId>
    <version>0.9</version>
</dependency>

<repositories>
    <repository>
        <id>yoava</id>
        <name>AOL yoava</name>
        <url>http://yoava.artifactoryonline.com/yoava/repo</url>
    </repository>
</repositories>
```

æµ‹è¯•ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•

```java
@Test
public void testRenderHtml() {
    String url = "http://www.baidu.com";
    HtmlImageGenerator generator = new HtmlImageGenerator();
    generator.loadUrl(url);

    BufferedImage img = generator.getBufferedImage();
    System.out.println("---");
}
```

æ¥ä¸‹æ¥å°±æ˜¯çœ‹è¾“å‡ºçš„å›¾ç‰‡äº†ï¼Œçœ‹ä¸‹æ˜¯å¦å’Œæˆ‘ä»¬é¢„æœŸç›¸åŒ

![html2img.png](http://s2.mogucdn.com/mlcdn/c45406/171217_3e12a2he6598kcj107cld089e699j_935x418.png)

è¿™ä¸ªé¢œè‰²ï¼Œæ ·å¼æœ‰ç‚¹é¬¼ç•œï¼ŒæŠ˜è…¾äº†ä¸€ç•ªï¼Œå®é™…éªŒè¯è¿™ä¸ªæ¡†æ¶æŒºä¸é”™çš„ï¼Œå°±æ˜¯æœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

- å¾ˆä¹…å¾ˆä¹…å¾ˆä¹…å¾ˆä¹…å¾ˆä¹…ä»¥å‰çš„äº§ç‰©äº†
- æ²¡äººç»´æŠ¤
- cssæ ·å¼æ”¯æŒä¸å‹å¥½

æ¢ä¸ªå¤æ‚ç‚¹çš„urlï¼Œæ¯”å¦‚æ·˜å®orè˜‘è‡è¡—å•†å“è¯¦æƒ…é¡µï¼Œè¿”å›å°±æ›´é¬¼ç•œäº†ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯è‡ªå·±å°è¯•ä¸€ä¸‹


#### b. xhtmlæ¸²æŸ“åŒ…

è¿™ä¸ªä¹Ÿå¯ä»¥å®ç°htmlæ¸²æŸ“ï¼Œåˆæ˜¯ä¸€ä¸ªè€å¤è‘£çº§åˆ«çš„ä¸œè¥¿ï¼Œå·²ç»å¿˜è®°ä»å“ªé‡Œæå‡ºæ¥çš„ï¼Œæœ€åˆå®ç°markdownæ¸²æŸ“æˆå›¾ç‰‡ï¼Œå°±æ˜¯é‡‡ç”¨çš„è¿™ä¸ªåŒ…ï¼Œå¯¹ç®€å•çš„cssçš„æ”¯æŒè¿˜ç®—å‹å¥½

pomä¾èµ–

```xml
<!--html to image render-->
<dependency>
    <groupId>org.xhtmlrenderer</groupId>
    <artifactId>core-renderer</artifactId>
    <version>R8</version>
</dependency>

<dependency>
    <groupId>net.sourceforge.nekohtml</groupId>
    <artifactId>nekohtml</artifactId>
    <version>1.9.14</version>
</dependency>
<!--html to image render-->
```

æµ‹è¯•case

```java
@Test
public void testRender() {
    try {
        String url = "http://www.baidu.com";
        BufferedImage buf = ImageRenderer.renderToImage(url, "/Users/yihui/html2image.pdf", 800);
        System.out.println("---");
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

ä½¿ç”¨èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯ï¼Œä¸Šé¢è¿™ç§ç›´æ¥æ‰§è¡Œï¼Œä¼šæŠ›å¼‚å¸¸ï¼Œè¯´è®¿é—®çš„htmlæœ‰äº›è¯­æ³•æœ‰é—®é¢˜; ç„¶ååšäº†ä¸€äº›ä¿®æ”¹å’Œè°ƒæ•´ï¼Œä¿®æ­£åçš„æµ‹è¯•ä»£ç 

```java
private static DOMParser domParser;

static {
    domParser = new DOMParser(new HTMLConfiguration());
    try {
        domParser.setProperty("http://cyberneko.org/html/properties/names/elems", "lower");
    } catch (Exception e) {
        throw new RuntimeException("Can't create HtmlParserImpl", e);
    }
}

private Document parseDocument(String content) throws Exception {
    domParser.parse(new InputSource(new StringReader(content)));
    return domParser.getDocument();
}


private String readHtmlContent(String url) throws Exception {
    InputStream in = HttpUtil.downFile(url);
    StringBuilder out = new StringBuilder();
    byte[] b = new byte[4096];
    for (int n; (n = in.read(b)) != -1; ) {
        out.append(new String(b, 0, n));
    }
    return out.toString();
}


@Test
public void testRender() {
    try {
        String url = "http://www.baidu.com";
        Document doc = parseDocument(readHtmlContent(url));

        int width = 800;
        int height = 1024;
        Graphics2DRenderer renderer = new Graphics2DRenderer();
        renderer.setDocument(doc, doc.getDocumentURI());


        BufferedImage bufferedImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
        Graphics2D graphics2D = GraphicUtil.getG2d(bufferedImage);


        // do layout with temp buffer
        renderer.layout(graphics2D, new Dimension(width, height));
        graphics2D.dispose();

        Rectangle size = renderer.getMinimumSize();
        final int autoWidth = width;
        final int autoHeight = (int) size.getHeight();
        bufferedImage = new BufferedImage(autoWidth, autoHeight, BufferedImage.TYPE_INT_RGB);
        Dimension dimension = new Dimension(autoWidth, autoHeight);

        graphics2D = GraphicUtil.getG2d(bufferedImage);


        renderer.layout(graphics2D, dimension);
        renderer.render(graphics2D);
        graphics2D.dispose();
        System.out.println("---------");
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

ç»“æœè¾“å‡ºå›¾ç‰‡ä¸ºç©ºç™½çš„é¡µé¢ï¼Œä¸ºå•¥ï¼Ÿ ä»”ç»†å»çœ‹ç™¾åº¦çš„ç½‘é¡µï¼Œå‘ç°æ²¡æœ‰domç»“æ„ï¼Œä¸€å †çš„jså’Œcssä»£ç ï¼Œæ¢ä¸ªæœ¬åœ°çš„htmlæ¥è¯•ä¸€ä¸‹ï¼Œè¾“å‡ºæ•ˆæœè¿˜ä¸é”™ï¼Œæˆ‘ä¹‹å‰åšäº†ä¸€ä¸ªå°å·¥å…·ï¼Œå®ç°markdownè½¬imageï¼Œå°±æ˜¯ç”¨çš„è¿™ä¸ªæ¡†æ¶åšä¸­è½¬ï¼Œå°†markdownç”Ÿæˆçš„htmlæ¸²æŸ“ä¸ºå›¾ç‰‡ï¼Œå½“ç„¶å¤æ‚ä¸€ç‚¹çš„csså°±ä¸è¡Œäº†

ç›¸ä¿¡çœ‹åˆ°è¿™é‡Œï¼Œè¿™ä¸ªåº“çš„ç¼ºé™·ä¹Ÿå¥½å¾ˆæ˜æ˜¾äº†ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒï¼Œè‡ªå·±ç©ç©è¿˜è¡Œ

- è¿‡äºå¤è€ï¼ŒåŸºæœ¬æ²¡äººç»´æŠ¤
- å¯¹htmlçš„æ ¼å¼æœ‰è¦æ±‚
- å¤æ‚çš„cssæ²¡æ³•ç©
- æŒ‡å®šå®½åº¦ä¹Ÿæ¯”è¾ƒæ¶å¿ƒ

---

#### c. å€ŸåŠ©è½¬pdfçš„åŒ…

javaä¸­ï¼Œæä¾›htmlè½¬pdfçš„åŒ…è¿˜ä¸å°‘ï¼Œå€ŸåŠ©è¿™äº›å·¥å…·ï¼Œä¹Ÿæ˜¯å¯ä»¥é—´æ¥å®ç°è¿™ä¸ªåŠŸèƒ½çš„ï¼Œå…·ä½“çš„å°±ä¸è´´äº†ï¼Œå¯ä»¥ç”¨çš„ä¸å°‘ï¼Œæ”¶é’±çš„ï¼Œå…è´¹çš„éƒ½æœ‰

æ¨èå‡ ä¸ªææ ‡è®°çš„

- [flyingsaucer](https://github.com/flyingsaucerproject/flyingsaucer)
- [openhtmltopdf](https://github.com/danfickle/openhtmltopdf)
- [itext](https://github.com/itext)

---

#### d. å°ç»“

åŸºæœ¬ä¸Šï¼Œæ²¡æœ‰æ‰¾åˆ°åˆä¹å¿ƒæ„çš„è½¬æ¢åŒ…ï¼Œå…¶å®æœ‰äº›åŒ…ä¹Ÿä¸é”™ï¼Œå¦‚æœæ·±å…¥è¿›å»æ”¹ä¸€æ³¢ï¼Œåº”è¯¥ä¹Ÿèƒ½ä½¿ç”¨ï¼Œç„¶å®é™…å°±æ˜¯æ·±å…¥è¿›å»ï¼ŒåŸºæœ¬ä¸ŠæŒ–ä¸åŠ¨

---

### 1. imagemagicçš„åˆæˆ

å¤§åé¼é¼çš„å›¾ç‰‡å¤„ç†å·¥å…·ï¼Œc++çš„ï¼Œå¯ä»¥æä¾›å›¾ç‰‡çš„å„ç§å§¿åŠ¿çš„æ“ä½œï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬äº†å›¾ç‰‡åˆæˆï¼Œè¦ç©è¿™ä¸ªï¼Œé¦–å…ˆå¾—æ­å»ºè¿™ä¸ªç¯å¢ƒï¼ˆè¿™ä¸ªæˆæœ¬æ¯”ä¸Šé¢ä¼šå¤§ä¸€ç‚¹ï¼‰

#### a. ç¯å¢ƒå‡†å¤‡

ç®€å•æ­å»ºæ–¹å¼ï¼š

```
yum install libjpeg-devel
yum install libpng-devel


# æœ¬åœ°ç¯å¢ƒæ­å»º
sudo brew install jpeg
sudo brew install libpng
sudo brew install GraphicsMagick
```

æ­å»ºå®Œæ¯•åï¼Œæµ‹è¯•å…ˆæ˜¯å¦å¯ç”¨

```
## æ­å»ºå®Œæ¯•ï¼Œå¼€å§‹æµ‹è¯•
gm convert input.jpg -thumbnail '100x100' output_1.jpg

gm convert -crop 640x960+0+0 test.jpg output.jpg
```

å¦‚æœä¸Šé¢çš„æä¸å®šï¼Œä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„ä¸‹è½½åŒ…çš„æ–¹å¼å®‰è£…

```
å®‰è£…jpeg åŒ… `wget ftp://223.202.54.10/pub/web/php/libjpeg-6b.tar.gz`
å®‰è£…webp åŒ… `wget http://www.imagemagick.org/download/delegates/libwebp-0.5.1.tar.gz`
å®‰è£…png åŒ… `wget http://www.imagemagick.org/download/delegates/libpng-1.6.24.tar.gz`
å®‰è£… graphicsmagick `wget http://nchc.dl.sourceforge.net/project/graphicsmagick/graphicsmagick/1.3.22/GraphicsMagick-1.3.22.tar.gz`

## ----------

make distclean ##  æ¸…æ¥šä¸Šæ¬¡makeçš„ä¸œè¥¿

imagemagick ï¼š

`wget http://www.imagemagick.org/download/ImageMagick.tar.gz`

å®‰è£…å‘½ä»¤  `sudo ./configure; sudo make; sudo make install`

è£å›¾å‘½ä»¤ `convert test.jpg -crop 640x960+0+0 output.jpg`
```

linux å®‰è£…imagemagick å‘ç°ä¸€ç›´æ‰¾ä¸åˆ° pngçš„ä¾èµ–ï¼Œ

linux å®‰è£…ä¹‹åï¼Œå¯èƒ½æœ‰ä¸¤ä¸ªé—®é¢˜

- imagemagick ä¾ç„¶æ— æ³•è¯»å–pngå›¾ç‰‡

  - æŸ¥é˜…éœ€è¦å®‰è£… http://pkgconfig.freedesktop.org/releases/pkg-config-0.28.tar.gz

- æ‰§è¡Œ convert æç¤ºlinux shared libraries ä¸åŒ…å«æŸä¸ªåº“ 
  - ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼š export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
  - ä¸€åŠ³æ°¸é€¸çš„æ–¹æ¡ˆï¼šhttps://my.oschina.net/guanyue/blog/220264
    - vi /etc/ld.so.conf åœ¨è¿™ä¸ªæ–‡ä»¶é‡ŒåŠ å…¥ï¼š/usr/local/lib æ¥æŒ‡æ˜å…±äº«åº“çš„æœç´¢ä½ç½® ç„¶åå†æ‰§è¡Œ/sbin/ldconf

----

#### b. javaè°ƒç”¨ 

å½“ç„¶ï¼Œæˆ‘ä»¬æ˜¯javaçš„åç«¯ï¼Œç°åœ¨å°±éœ€è¦ç”¨javaæ¥è°ƒç”¨imagemagicçš„æ‰§è¡Œäº†

ä¾èµ–åŒ…

```xml
<dependency>
    <groupId>org.im4java</groupId>
    <artifactId>im4java</artifactId>
    <version>1.4.0</version>
</dependency>
```

ä¸‹é¢ç»™ä¸€ä¸ªå›¾ç‰‡è£å‰ªçš„æµ‹è¯•

```java
/**
 * è£å‰ªå›¾ç‰‡
 *
 * @param imagePath æºå›¾ç‰‡è·¯å¾„
 * @param outPath   å¤„ç†åå›¾ç‰‡è·¯å¾„
 * @param x         èµ·å§‹Xåæ ‡
 * @param y         èµ·å§‹Yåæ ‡
 * @param width     è£å‰ªå®½åº¦
 * @param height    è£å‰ªé«˜åº¦
 * @return è¿”å›trueè¯´æ˜è£å‰ªæˆåŠŸ, å¦åˆ™å¤±è´¥
 */
public static boolean cut(String imagePath, String outPath, int x, int y,
                          int width, int height) {
    boolean flag;
    try {
        IMOperation op = new IMOperation();
        op.addImage(imagePath);
        /** widthï¼šè£å‰ªçš„å®½åº¦ * heightï¼šè£å‰ªçš„é«˜åº¦ * xï¼šè£å‰ªçš„æ¨ªåæ ‡ * yï¼šè£å‰ªçºµåæ ‡ */
        op.crop(width, height, x, y);
        op.addImage(outPath);
        // ä¼ trueåˆ°æ„é€ å‡½æ•°ä¸­,åˆ™è¡¨ç¤ºä½¿ç”¨GraphicMagic, è£å›¾æ—¶,å›¾ç‰‡å¤§å°ä¼šå˜
        ConvertCmd convert = new ConvertCmd();
        convert.run(op);
        flag = true;
    } catch (IOException e) {
        flag = false;
    } catch (InterruptedException e) {
        flag = false;
    } catch (IM4JavaException e) {
        flag = false;
    }
    return flag;
}
```

å…·ä½“ä½¿ç”¨å§¿åŠ¿å°±ä¸è¯´äº†ï¼Œè¿™ä¸ªæ¡†æ¶æœ¬èº«æ˜¯æ”¯æŒç®€å•çš„å›¾ç‰‡åˆæˆçš„ï¼Œå‡ å¼ å›¾å’Œä¸€ä¸‹ï¼ŒåŠ ä¸Šæ–‡å­—æ°´å°å•¥çš„ï¼Œä¸»è¦è¯´ä¸€ä¸‹æœ‰ä»€ä¹ˆé—®é¢˜

- å›¾ç‰‡åˆæˆå‚æ•°ä¸æ˜¯ä¸€èˆ¬çš„å¤æ‚ï¼Œæƒ³å®ç°ä¸€ä¸ªæ¨¡æ¿çš„åˆæˆï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥è¯´å¾ˆéš¾å®Œç¾çš„å†™å‡ºæ¥
- æ€§èƒ½ä¸€èˆ¬èˆ¬

æ€»å¾—æ¥è¯´ï¼Œè¿™ä¸ªç”¨æ¥åšå›¾ç‰‡çš„åŸºæœ¬æ“ä½œè¿˜å¾ˆå¥½ï¼ŒçœŸå¿ƒä¸å¤ªåˆé€‚å¤æ‚ç‚¹çš„å›¾ç‰‡åˆæˆï¼Œåˆ†åˆ†é’Ÿè™å“­

#### c. å…¶ä»–ä¸€äº›ä¸å¾—ä¸è¯´çš„æ•…äº‹

è¯´åˆ°imagemagicï¼Œå°±ä¸å¾—ä¸è¯´graphicmagicï¼Œä¸¤è€…åŸºæœ¬å·®ä¸å¤šï¼Œæœ‰è¯´æ³•æ˜¯ graphicmagicçš„æ€§èƒ½è¦é«˜ä¸imagemagicï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆé€‰æ‹© imagemagic

- graphicmagic å¤„ç†jpgå›¾ç‰‡ï¼Œä¼šæœ‰ç²¾åº¦ä¸¢å¤±çš„é—®é¢˜ï¼ˆä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘çš„ä½¿ç”¨å§¿åŠ¿ä¸å¯¹ï¼ŒåŒæ ·çš„caseï¼Œimagemagicä¸ä¼šï¼‰
- å…¬å¸çš„åŸºçº¿æ˜¯æ”¯æŒimagemagicçš„


å¾ˆä¹…ä»¥å‰å†™äº†ä¸€ç¯‡åšæ–‡ï¼Œå°±æ˜¯å¦‚ä½•åˆ©ç”¨ imagegraphic æ­å»ºä¸€ä¸ªå›¾ç‰‡å¤„ç†æœåŠ¡å™¨çš„

- [im4java + imagemagic æ­å»ºä¸€ä¸ªå›¾ç‰‡å¤„ç†æœåŠ¡](https://my.oschina.net/u/566591/blog/778851)

---

### 2. awtçš„ç»˜åˆ¶

åˆ©ç”¨javaçš„awtåŒ…ï¼Œä¹Ÿæ˜¯å¯ä»¥å®ç°ç»˜å›¾çš„ï¼Œè€Œä¸”åŠŸèƒ½ä¹Ÿæ¯”è¾ƒå¼ºå¤§ï¼Œå®Œå…¨å¯ä»¥å®ç°å„ç§å§¿åŠ¿çš„ç»˜å›¾åœºæ™¯, ä¸€ä¸ªcaseå¦‚ :

![case](http://s3.mogucdn.com/mlcdn/c45406/171203_36j204d8e1deild5li4c116b9c137_640x340.jpg)

ä¸Šé¢è¿™ä¸ªå›¾çš„åˆæˆï¼Œå°±æ˜¯åŸºäºawtåšåˆ°çš„ï¼Œè¿™ä¸€å¼ å›¾ï¼Œæˆ‘ä»¬éœ€è¦åšäº›ä»€ä¹ˆï¼Ÿ

- å›¾ç‰‡çš„ç»˜åˆ¶
- åœ†è§’å›¾ç‰‡
- æ–‡å­—è¾“å‡º
- æ–‡å­—å¯¹å…¶æ–¹å¼
- ç›´çº¿
- çŸ©å½¢
- çº¯è‰²èƒŒæ™¯

ä¸€èˆ¬æ¥å°†ï¼Œä¸Šé¢å‡ ç§åœºæ™¯çš„æ”¯æŒï¼Œå¯ä»¥æ»¡è¶³ç»å¤§å¤šæ•°çš„åˆå›¾è¦æ±‚ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•æ”¯æŒä¸Šé¢çš„å‡ ç§caseçš„

#### o. æ¥å£å®šä¹‰

å®šä¹‰ä¸€ä¸ªåŸºæœ¬çš„ç»˜å›¾å•å…ƒæ¥å£

```java
public interface IDrawBO {
}
```

#### a. å›¾ç‰‡ ï¼š ImgBO

å›¾ç‰‡çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œä¸€èˆ¬åªéœ€è¦çŸ¥é“åæ ‡ï¼Œå’Œå®½é«˜å°±okäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å®šä¹‰å¦‚ä¸‹

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class ImgBO implements IDrawBO {
    private BufferedImage image;

    private int x;

    private int y;

    private int w;

    private int h;

}
```

#### b. æ–‡å­—ï¼šFontBO

æ–‡å­—ç›¸æ¯”è¾ƒå›¾ç‰‡å°±æœ‰äº›é¢å¤–çš„åŒºåˆ«ï¼Œæœ‰å­—ä½“ï¼Œæ ·å¼ã€é¢œè‰²ï¼Œåæ ‡ï¼Œåˆ é™¤çº¿

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class FontBO implements IDrawBO {

    private String msgs;

    private Font font;

    private Color color;

    private int x;

    private int y;

    private boolean deleted = false;
}
```

#### c. ç›´çº¿: LineBO

ç›´çº¿ï¼Œé™¤äº†æˆ‘ä»¬å¸¸è§„çš„èµ·ç‚¹åæ ‡ï¼Œæœ«å°¾åæ ‡ä¹‹å¤–ï¼Œé¢œè‰²çš„è®¾ç½®ï¼Œè™šçº¿æ ·å¼ä¹Ÿæ˜¯å¸¸è§çš„å±æ€§

```java
@Data
public class LineBO implements IDrawBO {

    public static final Stroke DEFAULT_STROKE = new BasicStroke(2,
            BasicStroke.CAP_BUTT, BasicStroke.JOIN_ROUND,
            3.5f,
            new float[]{12, 6, 6, 6},
            0f);

    private Color color;

    private int x1;

    private int y1;

    private int x2;
    
    private int y2;

    /**
     * æ˜¯å¦æ˜¯è™šçº¿
     */
    private boolean dashed;
}
```


#### d. çŸ©å½¢ï¼š RoundRectBO

å’Œç›´çº¿çš„å±æ€§å·®ä¸å¤š, ä½†æ˜¯ä¼šå¤šä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿ï¼Œå¦‚æ˜¯å¦ä¸ºåœ†è§’çŸ©å½¢

```java
public class RoundRectBO implements IDrawBO {

    public static final Stroke DEFAULT_DASH = new BasicStroke(1,
            BasicStroke.CAP_BUTT, BasicStroke.JOIN_ROUND,
            3.5f,
            new float[]{4, 2,},
            0f);

    private int x;

    private int y;

    private int w;

    private int h;

    private Color color;

    /**
     * æ˜¯å¦ä¸ºè™šçº¿
     */
    private boolean dashed;


    /**
     * åœ†è§’å¼§åº¦
     */
    private int radius;
}
```

#### e. çº¯è‰²ï¼š ColorBgBO

çº¯è‰²èƒŒæ™¯ï¼Œç›¸æ¯”è¾ƒå…¶ä»–çš„ä¼šå¤šä¸€ä¸ªé€æ˜åº¦çš„å±æ€§ï¼Œä¸»è¦æ˜¯å› ä¸ºå¾ˆå¤šåœºæ™¯ä¸‹ï¼Œä¼šåšä¸€å±‚çº¯è‰²çš„æµ®å±‚

```java
@Data
public class ColorBgBO implements IDrawBO {

    private Color color;

    private int w;

    private int h;

    private int x;

    private int y;

    private int radius;

    private boolean transparence;
}
```

----

ä¸Šé¢å®šä¹‰äº†è¿™äº›BOå¯¹è±¡ï¼Œä»…ä»…æ˜¯å®šä¹‰åˆä»€ä¹ˆç”¨ï¼Ÿæ¥ä¸‹æ¥å°±éœ€è¦å®ç°å¯¹BOå¯¹è±¡çš„ç»˜åˆ¶ï¼Œä¹Ÿæ˜¯æ ¸å¿ƒçš„é€»è¾‘å±‚äº†

```java
/**
 * Created by yihui on 2017/9/21.
 */
public interface IShareModule {

    void draw(Graphics2D g2d);


    default void drawFont(Graphics2D g2d, FontBO fontBo) {
        if (fontBo != null) {
            g2d.setFont(fontBo.getFont());
            g2d.setColor(fontBo.getColor());
            g2d.drawString(fontBo.getMsgs(), fontBo.getX(), fontBo.getY());

            if (fontBo.isDeleted()) { // åˆ é™¤æ—¶ï¼Œéœ€è¦åœ¨æ–‡å­—ä¸Šç»˜åˆ¶ä¸€æ¡åˆ é™¤çº¿
                FontMetrics fontMetrics = FontUtil.getFontMetric(fontBo.getFont());
                int y = fontBo.getY() - (fontBo.getFont().getSize() >> 1) + fontMetrics.getDescent();
                int w = fontMetrics.stringWidth(fontBo.getMsgs());

                g2d.drawLine(fontBo.getX(), y, fontBo.getX() + w, y);
            }
        }
    }


    default void drawImage(Graphics2D g2d, ImgBO imgBo) {
        if (imgBo != null) {
            g2d.drawImage(imgBo.getImage(), imgBo.getX(), imgBo.getY(), imgBo.getW(), imgBo.getH(), null);
        }
    }


    default void drawLine(Graphics2D g2d, LineBO lineBO) {
        if(lineBo == null) return;
        g2d.setColor(lineBO.getColor());
        if (lineBO.isDashed()) {
            Stroke stroke = g2d.getStroke();
            g2d.setStroke(LineBO.DEFAULT_STROKE);
            g2d.drawLine(lineBO.getX(), lineBO.getY(), lineBO.getX() + lineBO.getW(), lineBO.getY());
            g2d.setStroke(stroke);
        } else {
            g2d.drawLine(lineBO.getX(), lineBO.getY(), lineBO.getX() + lineBO.getW(), lineBO.getY());
        }
    }


    default void drawRoundRect(Graphics2D g2d, RoundRectBO roundRectBO) {
        if(roundRectBO == null) return;
        g2d.setColor(roundRectBO.getColor());
        if (!roundRectBO.isDashed()) {
            g2d.drawRoundRect(roundRectBO.getX(), roundRectBO.getY(),
                    roundRectBO.getW(),
                    roundRectBO.getH(),
                    roundRectBO.getRadius(),
                    roundRectBO.getRadius());
        } else {
            Stroke stroke = g2d.getStroke();

            g2d.setStroke(RoundRectBO.DEFAULT_DASH);
            g2d.drawRoundRect(roundRectBO.getX(), roundRectBO.getY(),
                    roundRectBO.getW(),
                    roundRectBO.getH(),
                    roundRectBO.getRadius(),
                    roundRectBO.getRadius());
            g2d.setStroke(stroke);
        }


        if (roundRectBO.getSpaceW() > 0) { // ä¸Šè¾¹è·ç©ºç™½çš„å®½åº¦
            int x = roundRectBO.getX() + (roundRectBO.getW() - roundRectBO.getSpaceW() >> 1);
            int y = roundRectBO.getY() - 2;
            int w = roundRectBO.getSpaceW();
            int h = 4;
            g2d.setColor(roundRectBO.getSpaceColor());
            g2d.fillRect(x, y, w, h);
        }
    }
    
    
    
    default void drawColorBG(Graphics2D g2d, ColorBgBO color) {
        if(color == null) return;
        g2d.setColor(color.getColor());

        Composite composite = null;
        if (color.isTransparence()) {
            composite = g2d.getComposite();
            g2d.setComposite(AlphaComposite.Src);
        }

        if (color.getRadius() == 0) {
            g2d.fillRect(color.getX(), color.getY(), color.getW(), color.getH());
        } else {
            g2d.fill(new RoundRectangle2D.Float(color.getX(), color.getY(), color.getW(), color.getH(), color.getRadius(), color.getRadius()));
        }

        if (color.isTransparence()) {
            g2d.setComposite(composite);
        }
    }
}
```

ä¸Šé¢é…åˆèµ·æ¥ä½¿ç”¨ï¼Œå°±å¯ä»¥å®ç°åŸºæœ¬çš„æ¨¡æ¿å›¾ç‰‡çš„åˆæˆéœ€æ±‚äº†ï¼Œå½“ç„¶æˆ‘ä»¬æä¾›çš„æœåŠ¡æ¯”ä¸Šé¢åˆ—å‡ºçš„è¦ä¸°å¯Œä¸€äº›ï¼Œæˆ‘ä»¬è¿˜æ”¯æŒ

- å›¾ç‰‡çš„å¤„ç†ï¼šåœ†è§’ï¼Œè£å‰ªè´´å›¾
- æ–‡å­—å¯¹é½ï¼šä¸‰ç§å¯¹é½æ–¹å¼ï¼Œè‡ªåŠ¨æ¢è¡Œ

--- 

#### å°ç»“&é—®é¢˜

ä¸Šé¢è™½ç„¶è¯´å¯ä»¥æ”¯æŒåˆå›¾çš„éœ€æ±‚ï¼Œä½†æœ‰ä¸ªæœ€å¤§çš„é—®é¢˜ï¼Œå°±æ˜¯å¯¹åç«¯çš„å·¥ä½œå¤ªå¤šï¼Œæ¯ä¸ªæ¨¡æ¿ï¼Œéƒ½éœ€è¦åç«¯æ¥é…åˆï¼Œè¿›è¡Œå‚æ•°æŒ‡å®šï¼Œè”è°ƒï¼Œæå…¶ç¹çå’Œè´¹æ—¶è´¹åŠ›ï¼Œåˆ†åˆ†é’Ÿææ­»äºº

å¯¹è¿™ç§æ–¹å¼ï¼Œæƒ³çš„ä¸€ä¸ªæ–¹æ³•æ˜¯ï¼Œé‡‡ç”¨æ­ç§¯æœ¨çš„æ–¹å¼æ”¯æŒï¼Œäº‹å…ˆå®šä¹‰ä¸€ç³»åˆ—çš„åŸºæœ¬ç»˜å›¾ç»„å»ºï¼Œç„¶åå‰ç«¯è‡ªå·±å¡«å…¥å‚æ•°æ¥ç»„è£…

å½“ç„¶æ²¡æœ‰åšï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œæ¥å£å¤ªå¤æ‚ï¼Œå¯¹å‰ç«¯ä¸å‹å¥½ï¼Œæ²¡äººæ„¿æ„è¿™ä¹ˆç”¨ï¼Œæ¢æˆæˆ‘ä¹Ÿæ˜¯ä¸æƒ³è¿™ä¹ˆå¹²çš„

---

### 3. html è½¬ å›¾ç‰‡

æ¥ç€åˆæ¥çš„æ˜¯ä¸€ä¸ªçŒ¥ççš„æ–¹æ¡ˆï¼Œhtmlè½¬å›¾ï¼Œåˆ°githubä¸Šä¸€æœï¼Œå‘ç°è¿˜æ˜¯jsé è°±ï¼Œæ¯”è¾ƒå¤šï¼Œä¸€ç§å¸¸è§çš„æ€è·¯æ˜¯ï¼š

**é‡‡ç”¨æ— ç•Œé¢æµè§ˆå™¨åŠ è½½htmlé¡µé¢ï¼Œç„¶åæˆªå›¾**

åœ¨æ— ç•Œé¢æµè§ˆå™¨ä¸­ï¼Œéå¸¸æœ‰åçš„æ˜¯ phantomjsï¼Œä»¥åŠåèµ·ä¹‹ç§€chromeï¼Œè¿™é‡Œä¸»è¦è¯´ä¸€ä¸‹phantomjsçš„æ¥å…¥æ–¹å¼ï¼Œç®€å•æèµ·chrmoeçš„æ— ç•Œé¢ä½¿ç”¨æ–¹å¼

#### a. ç¯å¢ƒå‡†å¤‡

phantomjs å®‰è£…

```
# 1. ä¸‹è½½

## mac ç³»ç»Ÿ
wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-macosx.zip


## linux ç³»ç»Ÿ
wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2

## windows ç³»ç»Ÿ
## å°±ä¸è¦ç©äº†ï¼Œæ²¡å•¥æ„æ€


# 2. è§£å‹

sudo su 
tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2

# å¦‚æœè§£å‹æŠ¥é”™ï¼Œåˆ™å®‰è£…ä¸‹é¢çš„
# yum -y install bzip2

# 3. å®‰è£…

## ç®€å•ç‚¹ï¼Œç§»åŠ¨åˆ°binç›®å½•ä¸‹

cp phantomjs-2.1.1-linux-x86_64/bin/phantomjs /usr/local/bin

# 4. éªŒè¯æ˜¯å¦ok
phantomjs --version

# è¾“å‡ºç‰ˆæœ¬å·ï¼Œåˆ™è¡¨ç¤ºok
```

pomä¾èµ–

```xml
<!--phantomjs -->
<dependency>
    <groupId>org.seleniumhq.selenium</groupId>
    <artifactId>selenium-java</artifactId>
    <version>2.53.1</version>
</dependency>
<dependency>
    <groupId>com.github.detro</groupId>
    <artifactId>ghostdriver</artifactId>
    <version>2.1.0</version>
</dependency>



<repositories>
    <repository>
        <id>jitpack.io</id>
        <url>https://jitpack.io</url>
    </repository>
</repositories>
```

#### b. å®æµ‹

æ€è·¯æ¯”è¾ƒæ¸…æ™°ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ­å»ºä¸€ä¸ªphantomjsæœåŠ¡ï¼Œç„¶åjavaæ¥è°ƒç”¨ï¼Œä¸»è¦å€ŸåŠ©çš„æ˜¯seleniumå’Œghostdriverä¸¤ä¸ªå¼€æºåŒ…ï¼Œé¢å¤–æä¸€å¥ï¼Œseleniumåœ¨è‡ªåŠ¨åŒ–æµ‹è¯•å’Œçˆ¬è™«ä½¿ç”¨ä¸­éå¸¸æœ‰åï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±æœç´¢ç›¸å…³èµ„æ–™ï¼Œéå¸¸æœ‰æ„æ€çš„ä¸€ä¸ªä¸œè¥¿

**å›¾ç‰‡æ¸²æŸ“çš„ä¸»è¦ä¸šåŠ¡é€»è¾‘ï¼š**

```
public class Html2ImageByJsWrapper {

    private static PhantomJSDriver webDriver = getPhantomJs();

    private static PhantomJSDriver getPhantomJs() {
        //è®¾ç½®å¿…è¦å‚æ•°
        DesiredCapabilities dcaps = new DesiredCapabilities();
        //sslè¯ä¹¦æ”¯æŒ
        dcaps.setCapability("acceptSslCerts", true);
        //æˆªå±æ”¯æŒ
        dcaps.setCapability("takesScreenshot", true);
        //cssæœç´¢æ”¯æŒ
        dcaps.setCapability("cssSelectorsEnabled", true);
        //jsæ”¯æŒ
        dcaps.setJavascriptEnabled(true);
        //é©±åŠ¨æ”¯æŒï¼ˆç¬¬äºŒå‚æ•°è¡¨æ˜çš„æ˜¯ä½ çš„phantomjså¼•æ“æ‰€åœ¨çš„è·¯å¾„ï¼Œwhich/whereis phantomjså¯ä»¥æŸ¥çœ‹ï¼‰
        // fixme è¿™é‡Œå†™äº†æ‰§è¡Œï¼Œ å¯ä»¥è€ƒè™‘åˆ¤æ–­ç³»ç»Ÿæ˜¯å¦æœ‰å®‰è£…ï¼Œå¹¶è·å–å¯¹åº”çš„è·¯å¾„ or å¼€æ”¾å‡ºæ¥æŒ‡å®šè·¯å¾„
        dcaps.setCapability(PhantomJSDriverService.PHANTOMJS_EXECUTABLE_PATH_PROPERTY, "/usr/local/bin/phantomjs");
        //åˆ›å»ºæ— ç•Œé¢æµè§ˆå™¨å¯¹è±¡
        return new PhantomJSDriver(dcaps);
    }

    public static BufferedImage renderHtml2Image(String url) throws IOException {
        webDriver.get(url);
        File file = webDriver.getScreenshotAs(OutputType.FILE);
        return ImageIO.read(file);
    }
}
```

é‚£ä¹ˆæµ‹è¯•caseå°±å¾ˆå¥½å†™äº†

```
@Test
public void testRender() throws IOException {
    String url = "https://www.baidu.com";
    BufferedImage img = Html2ImageByJsWrapper.renderHtml2Image(url);
}
```

è¾“å‡ºå›¾ç‰‡

![IMAGE](http://s2.mogucdn.com/mlcdn/c45406/171217_1g98bj21aldjl0655h0adh8dh216a_810x600.jpg)

çœ‹åˆ°è¿™ä¸ªç»“æœä¹‹åï¼Œæ˜¯å¦ä¼šè§‰å¾—å·²ç»å®Œç¾äº†ï¼Ÿ

ç„¶è€Œå¹¶ä¸æ˜¯ï¼Œæµ‹è¯•ä¸€äº›éœ€è¦å¼‚æ­¥è¯·æ±‚çš„æ¥å£ï¼Œæ¯”è¾ƒæ¸£ï¼Œæ€§èƒ½å·®ï¼Œè¿”å›çš„æ ·å¼ä¼šé”™ä¹±

#### c. åˆ†æå°ç»“

è¿™ä¸ªæ–¹æ¡ˆä»å®ç°æ¥è®²ï¼Œæ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„ï¼Œä»æ”¯æŒæƒ…å†µæ¥è¯´ï¼Œé—®é¢˜å…¶å®ä¹Ÿä¸å¤ªå¤§ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç”¨è¿™ä¸ªæ–¹æ¡ˆå‘¢ï¼Ÿ

è¿™ä¸ªæ–¹æ¡ˆçš„æ”¯æŒï¼ŒåŸæœ¬æˆ‘çš„å¸Œæœ›æ˜¯å‰ç«¯ä¼ ç»™æˆ‘ä»¬éœ€è¦æ¸²æŸ“çš„html

- æ˜¯ç›´å‡ºå¥½çš„é¡µé¢
- æ‰€æœ‰çš„domç»“æ„å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œ
- å°½é‡ä¸è¦æœ‰ä»€ä¹ˆjsï¼Œ
- ä¸è¦æœ‰å¼‚æ­¥è¯·æ±‚ï¼Œ
- ä¸è¦åˆå¤æ‚çš„cssä¾èµ–ï¼Œ
- æ²¡æœ‰å¤§é‡çš„å›¾ç‰‡

ç„¶è€Œäº‹ä¸æ„¿è¿ï¼Œè‡³äºä¸ºä»€ä¹ˆä¸å®ç°è¿™æ ·çš„htmlï¼Œæˆ‘ä¹Ÿä¸å¤ªæ‡‚å‰ç«¯çš„æŠ€æœ¯éš¾ç‚¹åœ¨å“ªï¼Œä¸å¥½å¤šè¯„ï¼Œé‚£ä¹ˆä¹Ÿå°±åªå¥½è½¬æ–¹æ¡ˆäº† 


è¿˜æœ‰ä¸€ç‚¹ï¼Œå¯¹è¿™ä¸ªæ–¹æ¡ˆæˆ‘ä¸å¤ªæ»¡æ„çš„å°±æ˜¯æ€§èƒ½å¤ªæ¸£ï¼Œè€Œä¸”æˆ‘ä¹Ÿä¸çŸ¥é“å¯ä»¥æ€ä¹ˆå»ä¼˜åŒ–ï¼Œç®€å•æ¥è®²ï¼Œå°±æ˜¯è¿™ä¸ªjsæ¸²æŸ“ï¼Œå®Œå…¨ä¸åœ¨æˆ‘çš„æŠŠæ§ä¹‹å†…ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜ã€å¦‚ä½•å»ä¼˜åŒ–ã€å¦‚ä½•é˜²æ­¢ssrfæ”»å‡»ï¼Œæˆ‘éƒ½æ²¡æœ‰å¥½çš„è§£å†³åŠæ³•ï¼Œæ‰€ä»¥æˆ‘æœ¬äººä¹Ÿæ˜¯ä¸å–œæ¬¢è¿™ä¸ªæ–¹æ¡ˆçš„


#### d. chrome æ–¹å¼

chromeæµè§ˆå™¨ï¼Œå¤§å®¶éƒ½çŸ¥é“ï¼Œchromeè¿˜æœ‰ä¸€ç§æ— ç•Œé¢å¯åŠ¨æ–¹å¼ï¼Œå¯èƒ½çŸ¥é“çš„æ¯”è¾ƒå°‘äº†


åªè¦ä½ æœ¬æœºå®‰è£…äº†chromeæµè§ˆå™¨ï¼Œæ‰“å¼€æ§åˆ¶å°å°±å¯ä»¥æ„‰å¿«çš„ç©è€äº†ï¼Œhtmlè¾“å‡ºå›¾ç‰‡çš„æŒ‡ä»¤ä¸º

```sh
## è¾“å‡ºpdf
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --headless --print-to-pdf http://www.baidu.com

## è¾“å‡ºå›¾ç‰‡
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --headless --screenshot  http://www.baidu.com
```

è¾“å‡ºæˆªå›¾

![screenshot.png](http://s2.mogucdn.com/mlcdn/c45406/171217_3j6jcb9h24k4afkhih2gj5771l926_1600x1200.png)


**è¯´æ˜**

chrome headlessæœ‰å¾ˆå¤šæŒ‡ä»¤ï¼Œå¯è®¾ç½®çª—å£çš„å¤§å°è§£å†³ä¸Šé¢çš„è¾¹æ¡†é—®é¢˜ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç™¾åº¦

---

### 4. svg è½¬ å›¾ç‰‡

ç„¶åä¸‡èƒ½çš„å‰ç«¯åŒå­¦åˆæå‡ºäº†svgæ¸²æŸ“å›¾ç‰‡ï¼Œåœ¨æè¿™ä¸ªä¹‹å‰ï¼Œå®Œå…¨æ²¡æ¥è§¦è¿‡svgï¼Œä¹Ÿä¸çŸ¥é“svgæ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Œæ›´ä¸çŸ¥é“svgèƒ½ä¸èƒ½æ¸²æŸ“å‡ºå›¾ç‰‡ï¼ˆæœ€é‡è¦çš„æ˜¯javaæœ‰æ²¡æœ‰ç°æˆå¯ç”¨çš„åº“ï¼‰

æŸ¥äº†ä¸€ç•ªï¼Œä¸é”™ï¼Œå‘ç°apaceæœ‰ä¸ªbatikï¼Œå°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„


    æ’æ’­ä¸€å¥ï¼Œæ„Ÿè§‰æ— è®ºå¤šåçš„ä¸œè¥¿ï¼Œapacheæˆ–è€…æ˜¯googleéƒ½è‡³å°‘æœ‰é‚£ä¹ˆä¸€ä¸ªå¯ä»¥æ”¯æŒçš„å¼€æºé¡¹ç›®ï¼Œè™½ç„¶æœ‰ä¸å°‘éƒ½å·²ç»ä¸æ€ä¹ˆç»´æŠ¤äº†

#### a. ä¾èµ–æ•´ç†

ä¾èµ–åŒ…æœ‰é‚£ä¹ˆç‚¹å¤š

```xml
<!--batik svg to image-->
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-svggen</artifactId>
    <version>1.8</version>
</dependency>
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-bridge</artifactId>
    <version>1.8</version>
    <exclusions>
        <exclusion>
            <groupId>xalan</groupId>
            <artifactId>xalan</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-dom</artifactId>
    <version>1.8</version>
    <exclusions>
        <exclusion>
            <groupId>xalan</groupId>
            <artifactId>xalan</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-parser</artifactId>
    <version>1.8</version>
</dependency>
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-svg-dom</artifactId>
    <version>1.8</version>
</dependency>
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-transcoder</artifactId>
    <version>1.8</version>
</dependency>
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-util</artifactId>
    <version>1.8</version>
</dependency>
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-xml</artifactId>
    <version>1.8</version>
</dependency>
<!-- https://mvnrepository.com/artifact/org.apache.xmlgraphics/xmlgraphics-commons -->
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>xmlgraphics-commons</artifactId>
    <version>2.1</version>
</dependency>
<!-- https://mvnrepository.com/artifact/org.apache.xmlgraphics/batik-codec -->
<dependency>
    <groupId>org.apache.xmlgraphics</groupId>
    <artifactId>batik-codec</artifactId>
    <version>1.8</version>
</dependency> <!-- æ­¤å¤„ä¸èƒ½ä½¿ç”¨2.9.1ç‰ˆæœ¬ï¼Œä½¿ç”¨2.9.1ç”Ÿæˆpngä¼šå¤±è´¥ -->
<!--<dependency>-->
    <!--<groupId>xerces</groupId>-->
    <!--<artifactId>xercesImpl</artifactId>-->
    <!--<version>2.5.0</version>-->
<!--</dependency>-->
<dependency>
    <groupId>xml-apis</groupId>
    <artifactId>xmlParserAPIs</artifactId>
    <version>2.0.2</version>
</dependency>
<dependency>
    <groupId>org.axsl.org.w3c.dom.svg</groupId>
    <artifactId>svg-dom-java</artifactId>
    <version>1.1</version>
</dependency>
<dependency>
    <groupId>xml-apis</groupId>
    <artifactId>xml-apis</artifactId>
    <version>2.0.0</version>
</dependency>
<dependency>
    <groupId>org.w3c.css</groupId>
    <artifactId>sac</artifactId>
    <version>1.3</version>
</dependency>
```


#### b. å®æµ‹

ä¸€ä¸ªç®€å•çš„æ¥å£æ”¯æŒ

```java
public static void convertToPngByFile(String path, OutputStream outputStream, Map<String, String> parmMap)
			throws TranscoderException, IOException {
	try {
	  // 1. åŠ è½½document
		File file = new File(path);
		String parser = XMLResourceDescriptor.getXMLParserClassName();
		SAXSVGDocumentFactory f = new SAXSVGDocumentFactory(parser);
		Document doc = f.createDocument(file.toURI().toString());

		
		// 2. éå†å‚æ•°ï¼Œå¡«å……æ¸²æŸ“çš„svgèŠ‚ç‚¹
		Set<String> keySet = parmMap.keySet();
		for (Map.Entry<String, String> entry : parmMap.entrySet()) {
			doc.getElementById(entry.getKey()).setTextContent(entry.getValue());
		}
		
		// 3. è¾“å‡ºå›¾ç‰‡
		PNGTranscoder t = new PNGTranscoder();
		TranscoderInput input = new TranscoderInput(doc);
		TranscoderOutput output = new TranscoderOutput(outputStream);
		t.transcode(input, output);
		outputStream.flush();
	} catch (Exception e) {
		e.printStackTrace();
	} finally {
		if (outputStream != null) {
			try {
				outputStream.close();
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
	}
}
```

ä¸Šé¢ä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºä¸‹ä½¿ç”¨å§¿åŠ¿ï¼Œå®é™…çš„é¡¹ç›®ä¸­è‚¯å®šä¸ä¼šè¿™ä¹ˆç®€é™‹ï¼Œå®˜æ–¹ä½¿ç”¨é“¾æ¥: [https://xmlgraphics.apache.org/batik/using/transcoder.html](https://xmlgraphics.apache.org/batik/using/transcoder.html)

åˆ†æä¸‹ä¸»è¦æµç¨‹

- è§£æsvgæ–‡ä»¶ï¼ŒåŠ è½½Documentå¯¹è±¡
- æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼Œå¡«å……Documentä¸­çš„èŠ‚ç‚¹
- æ¸²æŸ“è¾“å‡ºå›¾ç‰‡


æµ‹è¯•æ¼”ç¤ºå°±ä¸æ¥äº†ï¼Œæœ€ç»ˆæ–¹æ¡ˆå°±æ˜¯è¿™ä¸ªï¼Œæˆå“ä¹Ÿæ²¡å•¥å¥½è¯´çš„

#### c. é—®é¢˜

1. æ–‡æœ¬çš„è¾¹æ¡†æ”¯æŒé—®é¢˜: å³ outlineå±æ€§

    æµ‹è¯•äº†å¥½ä¹…ï¼Œå‘ç°ä¸æ”¯æŒè¿™ä¸ªå±æ€§
    
2. å›¾ç‰‡å†…å®¹æ›¿æ¢ä¸æ–‡æœ¬å†…å®¹æ›¿æ¢æ˜¯ä¸ä¸€æ ·çš„ï¼Œéœ€è¦åŒºåˆ†å¯¹å¾…

3. å¤šä¸ªæ ‡ç­¾å¡«å……åŒæ ·çš„å†…å®¹æ—¶

    ä»æ¥å£ä¸Šæ¥çœ‹ï¼Œæ”¯æŒä¸€ä¸ªæ ¹æ®Nameæ¥è·å–èŠ‚ç‚¹åŠŸèƒ½ï¼Œä½†æ˜¯å®é™…æµ‹è¯•ï¼Œå‘ç°æ ‡ç­¾nameå±æ€§ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆé¸Ÿç”¨ï¼›ä¸çŸ¥é“æ˜¯ä½¿ç”¨å§¿åŠ¿é—®é¢˜è¿˜æ˜¯åˆ«çš„
    
    ç„¶åç¿»çœ‹æºç ï¼Œå‘ç°å½“å¤šä¸ªæ ‡ç­¾çš„idç›¸åŒæ—¶ï¼Œåœ¨Documentçš„åº•å±‚å­˜å‚¨å•å…ƒä¸­ï¼ŒelementById è¿™ä¸ªMapç»“æ„ä¸­ï¼Œvalueä¼šæ˜¯ä¸€ä¸ªæ•°ç»„
    
    ç„¶åè‡ªç„¶è€Œç„¶çš„æƒ³æ³•å°±æ˜¯ï¼Œç›´æ¥éå†è¿™ä¸ªæ•°ç»„ï¼Œä¾æ¬¡å¡«å……å†…å®¹å°±å¥½ï¼›ç»“æœå‘ç°å‹æ ¹å°±æ²¡æœ‰æš´éœ²è¿™ä¸ªæ¥å£ï¼Œè€Œè¿™ä¸ªå±æ€§æ˜¯protectdï¼Œä¹Ÿæ— æ³•ç›´æ¥è®¿é—®
    
    ç„¶åé‡‡ç”¨åå°„è·å–è¿™ä¸ªå±æ€§å€¼ï¼Œæ¥ç»•è¿‡é™åˆ¶
    
4. æ¨¡æ¿åŠ è½½ç¼“å­˜

    å®é™…åœºæ™¯ä¸­ï¼Œæ¨¡æ¿å¾€å¾€æ˜¯å›ºå®šçš„ï¼Œæ¯æ¬¡éƒ½è¿›è¡Œæ¸²æŸ“æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½çš„ï¼Œå› æ­¤æƒ³çš„æ˜¯èƒ½ä¸èƒ½ç¼“å­˜ä½è¿™ä¸ªDocumentï¼Œå†ä½¿ç”¨çš„æ—¶å€™ï¼Œç›´æ¥æ·±æ‹·è´ä¸€ä¸ªå¯¹è±¡å‡ºæ¥ï¼Œè¿™æ ·å°±é¿å…äº†é‡å¤åŠ è½½çš„å¼€é”€
    
    ç›´æ¥ä½¿ç”¨ `AbstractDocumen#deepClone(true)` æ–¹æ³•
    
    
ç„¶åï¼Œå‡ºç°äº†ä¸€ä¸ªé¬¼ç•œçš„å¹¶å‘é—®é¢˜ï¼Œè¿™ä¸ªå•ç‹¬é¢†å‡ºæ¥ç»†è¯´ï¼Œæ­¤å¤„ä¸å±•å¼€

---

## III. æœ€åæ”¶å°¾

é‰´äºç¯‡å¹…å¤ªé•¿ï¼Œæœ‰ä¸€äº›æœ‰æ„æ€çš„ä¸œè¥¿æ²¡æœ‰æ·±å…¥å±•å¼€ï¼Œç‰¹åˆ«æ˜¯svgæ–¹æ¡ˆçš„æ”¯æŒä¸­ï¼Œé‡åˆ°äº†ä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜ï¼Œä¹Ÿæ¶‰åŠåˆ°ä¸‰ä¸ªå¥½ç©çš„çŸ¥è¯†ç‚¹ï¼š æ·±æ‹·è´+åå°„+å¹¶å‘ï¼Œåé¢å‡†å¤‡ç­‰è¿™ä¸€å—å®Œç»“ä¹‹åï¼Œå¥½å¥½çš„æ²‰æ·€ä¸‹ï¼Œåˆ†æä¸‹è¿™ä¸ªcase

### 1. åæ§½

åç«¯æ”¯æŒå·²ç»å¾ˆå‹‰å¼ºäº†ï¼Œè¯·å¤§å®¶éƒ½å‹å¥½ç‚¹ï¼Œæ¯”å¦‚ä¸‹é¢å‡ ä¸ªæˆ‘å®åœ¨æ”¯æŒä¸äº†

- è‡ªå®šä¹‰è®¾ç½®å­—ä½“ï¼ˆjdkå­—ä½“ï¼Œæ²¡æ–°åŠ ä¸€ä¸ªéƒ½éœ€è¦peå®‰è£…åˆ°jreçš„å­—ä½“åº“ï¼‰
- å›¾ç‰‡çš„å·¦ä¸Šè§’åœ†è§’ï¼ˆæš‚æ—¶æ²¡æƒ³åˆ°å¥½çš„è§£å†³æ–¹æ³•ï¼‰
- æ¸å˜è‰²ï¼ˆè¿™ä¸ªæœ‰ç‚¹éš¾ï¼‰

è¿™ä¸ªéœ€æ±‚ï¼Œåšå¾—æ¯”è¾ƒæ¶å¿ƒï¼Œæ”¯æŒå¾—ä¹Ÿæ¯”è¾ƒè›‹ç–¼ï¼Œå®ç°å¾—æ¯”è¾ƒçŒ¥çï¼Œè°ƒbugä¿®é—®é¢˜ä¹Ÿæ¯”è¾ƒé—¹å¿ƒï¼Œæ€»å¾—æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªå¼€å§‹å‰å¾ˆæœ‰è¶£ï¼Œåšæ—¶è®©äººåè¡€åˆå¾ˆä¸çˆ½ï¼Œåšå®Œä¹‹ååˆç‰¹ä¹ˆçš„å¾ˆæœ‰æ”¶è·çš„éœ€æ±‚


å‘ç°ç‰¹åˆ«èƒ½æœ‰æ”¶è·çš„äº‹æƒ…ï¼Œå¾€å¾€ä¸æ˜¯å“ªç§åšçš„ç‰¹åˆ«çˆ½çš„éœ€æ±‚ï¼ˆçˆ½ï¼Œæ˜¯å› ä¸ºè¿™äº›ä¸œè¥¿ä½ éƒ½å®Œå…¨èƒ½holdä½ï¼Œæ²¡ä»€ä¹ˆéš¾åº¦äº†ï¼‰ï¼Œç›¸åæ˜¯é‚£äº›è®©ä½ å¾ˆé—¹å¿ƒï¼Œå®Œå…¨ä¸æƒ³ç»§ç»­ä¸‹å»çš„éœ€æ±‚ï¼ˆå› ä¸ºä½ ä¸äº†è§£ï¼Œä½†æ˜¯åˆä¸å¾—ä¸æ”¯æŒï¼Œè¿˜ä¼šé‡åˆ°ä¸€å †é¬¼ç•œçš„bugï¼Œåšå®Œç®€ç›´æ˜¯åè¡€ä¸‰å‡ï¼‰

### 2. å°ç»“

å›¾ç‰‡åˆæˆçš„æ–¹å¼ï¼Œæˆ‘æƒ³åº”è¯¥ä¸ä»…é™äºä¸Šé¢å‡ ç§ï¼Œç”±äºé™åˆ¶äºè§è¯†ï¼Œç»ˆç©¶æ˜¯æ²¡æœ‰ä¸€ä¸ªè®©äººç‰¹åˆ«æ»¡æ„çš„æ–¹æ¡ˆï¼Œç®€å•å°ç»“ä¸‹ä¸Šé¢çš„å‡ ç§case

- javaçš„å¼€æºåŒ…
  - html2image, xhtmlrender, pdfTech
  - ä¸€èˆ¬æ¥è¯´ï¼Œä¸æ€ä¹ˆå¥½ç”¨ï¼Œå¤§å¤šä¸ç»´æŠ¤çŠ¶æ€ï¼Œå¯¹CSSçš„æ”¯æŒå‹å¥½åº¦å¾…æ£€éªŒ
- imagemagic
  - é€‚ç”¨äºå›¾ç‰‡çš„åŸºæœ¬å¤„ç†ï¼Œåˆå›¾å¤ªå¤æ‚
- awtç»˜å›¾
  - å±äºåŸºæœ¬çš„æ¥å£äº†ï¼Œå•¥éƒ½å¯ä»¥å¹²ï¼Œåªè¦ä½ å¯ä»¥å¼„å‡ºæ¥
  - ä½†æ˜¯å·¥ä½œé‡å¤ªå¤§
- jså®ç°htmlæ¸²æŸ“
  - phantmjsï¼Œæ•ˆæœä¸é”™ï¼Œæ€§èƒ½ç•¥æ¸£ï¼Œå¼‚æ­¥è¯·æ±‚ä¸å‹å¥½ï¼Œä¸”å®Œå…¨ä¸å¯æ§
  - chrome æ€§èƒ½ç”±äºä¸Šé¢çš„
- svgæ¸²æŸ“
  - batik
  - å¹¶ä¸èƒ½éå¸¸å®Œç¾çš„æ”¯æŒsvgçš„æ¸²æŸ“ï¼Œæœ‰è¾ƒå¤šçš„é™åˆ¶è¦æ±‚ï¼Œå„ç§å±æ€§çš„å¿…å¡«ï¼ŒæŸäº›styleçš„æ— æ³•æ”¯æŒç­‰
  - åŸºæœ¬åœºæ™¯çš„æ”¯æŒï¼Œokï¼Œä¼˜åŒ–åï¼Œæ€§èƒ½é«˜äºhtmlæ¸²æŸ“ï¼Œä¸”å¯æ§
  

